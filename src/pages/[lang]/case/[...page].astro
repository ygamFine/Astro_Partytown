---
import SecondaryPageLayout from '@components/templates/layout/SecondaryPageLayout.astro';
import EnhancedGridList from '@components/templates/common/EnhancedGridList.astro';
import ViewToggle from '@components/templates/common/ViewToggle.astro';
import Pagination from '@components/templates/common/Pagination.astro';
import EmptyState from '@components/templates/common/EmptyState.astro';
import { getCases } from '@apis/common.js';
import { getDictionary } from '@i18n/dictionaries.js';
import { getCategoryInfo, generateStaticPaths } from '@utils/pageUtils.js';
import { generateCategoryBreadcrumbs, generateCaseListBreadcrumbs } from '@utils/breadcrumbUtils.js';
import { themeConfig } from '@config/theme.js';
import { generateUrl } from '@utils/tools.js';

// 定义 Props 类型
interface PageProps {
  lang: string;
  categoryPath?: string;
  page?: number;
  totalPages?: number;
  items?: any[];
}

const MODEL = 'case';
const MODEL_PATH = '/case';

// 生成静态路径
export async function getStaticPaths() {
  const productsPerPage = 9;
  return generateStaticPaths(productsPerPage, MODEL);
}

const { lang, categoryPath, page, totalPages, items } = Astro.props as PageProps;
console.log(['categoryPath', categoryPath])
// 将字符串形式的 categoryPath 转换为数组
const categoryPathArray = categoryPath && categoryPath.length > 0 
  ? categoryPath.split('/').filter(segment => segment !== '')
  : [];

const categoryInfo = await getCategoryInfo(lang, categoryPathArray, MODEL);
const t = await getDictionary(lang);

// 面包屑导航
console.log('参数打印', lang, categoryPath, t.case.title)
const breadcrumbs = categoryPath && categoryPath.length > 0 
  ? generateCategoryBreadcrumbs(lang, categoryPath, MODEL_PATH, t.case.title)
  : generateCaseListBreadcrumbs(lang);

---

<SecondaryPageLayout 
title={categoryInfo.current.name || t.case.title}
  breadcrumbs={breadcrumbs}
  pageType={MODEL}
  currentSection={MODEL}
  contentType="grid"
  lang={lang}
>
  {items && items.length > 0 ? (
    <>
      <!-- 视图切换控件 -->
      <ViewToggle 
        currentView="grid"
        translations={t.common}
        lang={lang}
        totalItems={items?.length || 0}
        showTotal={true}
      />
      
      <!-- 案例列表 -->
      <EnhancedGridList 
        items={items || []}
        itemsPerRow={3}
        maxRows={3}
        mode="case"
        translations={t.common}
        lang={lang}
        viewMode="grid"
      />
      
      {/* 列表描述内容 - 分页上方模式 */}
      {themeConfig.layout.listDescription.displayMode === 'above-pagination' && (
        <div class="mt-8 mb-6">
          <p class="text-lg text-gray-600 leading-relaxed">
            {/* TODO: 缺少描述字段 */}
          </p>
        </div>
      )}
      
      <!-- 分页控件 -->
      {totalPages && totalPages > 1 && (
        <Pagination
          currentPage={page || 1}
          totalPages={totalPages}
          baseUrl={generateUrl(lang, MODEL_PATH)}
          i18n={t.common}
        />
      )}
    </>
  ) : (
    <EmptyState 
      title={t.case.empty_state.no_cases_title}
      description={t.case.empty_state.no_cases_description}
      icon={MODEL}
      lang={lang}
  />
  )}
</SecondaryPageLayout> 