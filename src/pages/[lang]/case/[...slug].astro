---
import SecondaryPageLayout from "@components/templates/layout/SecondaryPageLayout.astro";
import EmptyState from '@components/templates/common/EmptyState.astro';
import PageNavigation from '@components/templates/common/PageNavigation.astro';
import RelatedNews from '@components/templates/common/RelatedNews.astro';
import RelatedCasesSidebar from '@components/templates/common/RelatedCasesSidebar.astro';
import { getByCenterData } from '@apis/common';
import { generateCategoryBreadcrumbs } from '@utils/breadcrumbUtils';
import { formatDate, generateUrl } from '@utils/tools';
import { getDictionary } from '@i18n/dictionaries';
import RichText from '@components/common/layout/RichText.astro';
import StaticPaths, { type PageProps, type Category, type Pages } from '@utils/StaticPaths';

export async function getStaticPaths() {  
  return await new StaticPaths().detailStaticPaths('case');
}

const { lang, category, pages } = Astro.props as PageProps;
const { path = '', name = '' } = category as Category;
const { items, item } = pages as Pages;

// 如果产品不存在，返回404
if (!item) {
  return Astro.redirect("/404");
}

// 检查是否有案例数据
const hasCase = item !== null;

// 加载国际化翻译
const t = await getDictionary(lang);

// 获取当前产品在列表中的位置，用于上一个/下一个导航
const currentIndex = items && Array.isArray(items) ? items.findIndex(
  (p: any) => p.url_slug === item.url_slug,
) : -1;
const previousCase = currentIndex > 0 && items && Array.isArray(items) ? items[currentIndex - 1] : null;
const nextCase = currentIndex < (items?.length || 0) - 1 && items && Array.isArray(items) ? items[currentIndex + 1] : null;


// 获取相关新闻 (最新的4篇，排除当前文章) -> 用于主内容区底部
const allNews = await getByCenterData(lang, 'news');
const relatedNews = allNews && Array.isArray(allNews) ? allNews.slice(0, 4) : [];

// 获取相关案例（排除当前案例，取前3个）
const relatedCases = items && Array.isArray(items) ? items.filter((c: any) => c.case_category?.id == item?.case_category?.id).slice(0, 3) : [];

const breadcrumbs = await generateCategoryBreadcrumbs(lang, 'case', [{ path, name }, { path: item.url_slug, name: item.title }]) || [];

---
<>
{!hasCase ? (
  <SecondaryPageLayout
    breadcrumbs={breadcrumbs}
    lang={lang}
    showContentTitle={false}
    hideSidebar={true}
  >
      <div class="container mx-auto px-4 py-8">
        <EmptyState 
          title={t.case.empty_state.no_cases_title}
          description={t.case.empty_state.no_cases_description}
          icon="case"
          lang={lang}
          actions={[{
            label: t.case.empty_state.back_to_case_list,
            href: generateUrl(lang, '/case'),
            variant: 'secondary'
          }]}
        />
      </div>
  </SecondaryPageLayout>
  ) : (
  <SecondaryPageLayout
    breadcrumbs={breadcrumbs}
    lang={lang}
    showContentTitle={false}
    hideSidebar={true}
  >
    <div class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
        <!-- 主要内容区域 -->
        <div class="xl:col-span-3">
          <!-- 案例标题和信息 -->
          <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <!-- 案例头部信息 -->
            <header class="mb-8">
              <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 leading-tight" data-pagefind-title>{item.title}</h1>
              <time datetime={formatDate(item.publishedAt)} class="text-sm text-gray-500 mb-6 block" data-pagefind-date>{formatDate(item.publishedAt)}</time>
            </header>

            <!-- 案例详细内容 -->
            {item.details && (
              <RichText lang={lang} content={item.details} />
              // <div class="mb-8" data-pagefind-content set:html={casesItem.details}></div>
            )}
            
            <!-- 案例元数据 -->
            <div class="hidden" data-pagefind-category="case">
            </div>
          </div>

          <!-- Previous/Next 导航 -->
          <PageNavigation previous={previousCase} next={nextCase} lang={lang} mode="case" />

          <!-- Related News -->
          <RelatedNews relatedNews={relatedNews} lang={lang} />
        </div>

        <!-- 侧边栏 -->
        <RelatedCasesSidebar validRelatedCases={relatedCases} lang={lang} />
      </div>
    </div>
  </SecondaryPageLayout>
)}
</>
<style is:global>
  .prose h3 {
    @apply text-2xl font-bold my-6 text-gray-800;
  }
  .prose p {
    @apply mb-6;
  }

</style> 