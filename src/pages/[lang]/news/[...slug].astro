---
import SecondaryPageLayout from "@components/templates/layout/SecondaryPageLayout.astro";
import GridList from "@components/templates/common/GridList.astro";
import RelatedNews from "@components/templates/common/RelatedNews.astro";
import PopularArticles from "@components/templates/common/PopularArticles.astro";
import PageNavigation from "@components/templates/common/PageNavigation.astro";
import EmptyState from "@components/templates/common/EmptyState.astro";
import { getByCenterData } from "@apis/common";
import { getDictionary } from "@i18n/dictionaries";
import { getFirstImage, formatDate, generateUrl } from "@utils/tools";
import { generateCategoryBreadcrumbs } from "@utils/breadcrumbUtils";
import RichText from "@components/common/layout/RichText.astro";
import StaticPaths, { type PageProps, type Category, type Pages } from '@utils/StaticPaths';

export async function getStaticPaths() {  
  return await new StaticPaths().detailStaticPaths('news');
}

const { lang, category, pages } = Astro.props as PageProps;
const { path = '', name = '' } = category as Category;
const { items, item } = pages as Pages;


// 如果产品不存在，返回404
if (!item) {
  return Astro.redirect("/404");
}

// 检查是否有新闻数据
const hasNews = item !== null;

// 加载国际化翻译
const t = await getDictionary(lang);

// 获取当前新闻在列表中的位置，用于上一个/下一个导航
const currentIndex = items?.findIndex(
  (p: any) => p.url_slug === item.url_slug,
);
const previousNews = currentIndex && currentIndex > 0 ? items?.[currentIndex - 1] : null;
const nextNews = currentIndex && items?.length && currentIndex < items?.length - 1 ? items?.[currentIndex + 1] : null;

// 获取3个相关产品（随机）
const products = await getByCenterData(lang, 'product', { isLoadImg: true });
const shuffledProducts = products.sort(() => 0.5 - Math.random());
const relatedProducts = shuffledProducts.slice(0, 3);


  const filterNews = (num: number): any[] => {
    return (items ?? [])
      .filter((p: any) => p.url_slug !== item?.url_slug)
      .sort(
        (a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime(),
      )
      .slice(0, num);
  }

  // 面包屑导航
  const breadcrumbs = await generateCategoryBreadcrumbs(lang, 'news', [{ path: path, name: name }, { path: item.url_slug, name: item.title }]) || [];

---
<>
{ !hasNews ? (
  <SecondaryPageLayout
    breadcrumbs={breadcrumbs}
    lang={lang}
    showContentTitle={false}
    hideSidebar={true}
  >
      <div class="container mx-auto px-4 py-8">
        <EmptyState 
          title={t.news.empty_state.no_news_title}
          description={t.news.empty_state.no_news_description}
          icon="news"
          lang={lang}
        actions={[{
            label: t.news.empty_state.back_to_news_list,
            href: generateUrl(lang, '/news'),
            variant: 'secondary'
          }]}
        />
      </div>
  </SecondaryPageLayout>
  ) : (
  <SecondaryPageLayout
    breadcrumbs={breadcrumbs}
    lang={lang}
    showContentTitle={false}
    hideSidebar={true}
  >
    <!-- Pagefind 图片元数据 -->
    <div
      data-pagefind-meta="image"
      data-pagefind-meta-image={getFirstImage(item?.image)?.url}
      style="display: none;"
    >
    </div>
    <!-- Main Content Section -->
    <div class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- 中间主内容区 -->
        <div class="lg:col-span-3">
          <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <article>
              <!-- Article Header -->
              <header class="mb-8">
                <h1
                  class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 leading-tight"
                >
                  {item.title}
                </h1>
                <time
                  datetime={formatDate(item.publishedAt)}
                  class="text-sm text-gray-500 block"
                  >{formatDate(item.publishedAt)}</time
                >
              </header>
              <!-- Article Content -->
              <RichText lang={lang} content={item.news_detail} />
              {/* <div class="prose max-w-none" set:html={newsItem.news_detail} /> */}
            </article>
          </div>

          <!-- Previous/Next 导航 -->
          <PageNavigation previous={previousNews} next={nextNews} lang={lang} mode="news" />

          <!-- Related Products -->
          <div class="bg-white rounded-lg p-8 shadow-sm mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
              <div class="w-1 h-6 bg-red-600 mr-3"></div>
              {t.related.products}
            </h2>
            <GridList
              items={relatedProducts && Array.isArray(relatedProducts) ? relatedProducts.map((p: any) => ({
                id: p.id,
                title: p.title, // 使用 name 字段作为 title
                image: p.image,
                excerpt: p.excerpt,
                href: generateUrl(lang, '/products', p.url_slug),
              })) : []}
              itemsPerRow={3}
              translations={{ common: t.common }}
              lang={lang}
            />
          </div>

          <!-- Related News -->
          <RelatedNews relatedNews={filterNews(4)} lang={lang} />
        </div>

        <!-- 右侧热门文章 -->
        <PopularArticles popularArticles={filterNews(5)} lang={lang} />
      </div>
    </div>
  </SecondaryPageLayout>
)}
</>
<style is:global>
  .prose {
    @apply text-gray-800 leading-relaxed;
  }
  .prose h1,
  .prose h2,
  .prose h3,
  .prose h4,
  .prose h5,
  .prose h6 {
    @apply text-gray-900 font-bold;
  }
  .prose a {
    @apply text-blue-600 hover:underline;
  }
  .prose p {
    @apply my-4;
  }
  .prose ul,
  .prose ol {
    @apply my-4 pl-6;
  }
  .prose li {
    @apply mb-2;
  }
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
