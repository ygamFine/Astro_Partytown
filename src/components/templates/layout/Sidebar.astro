---
interface Props {
  currentSection?: 'products' | 'news' | 'cases';
}

const { currentSection } = Astro.props;
const currentPath = Astro.url.pathname;

// å¯¼å…¥ä¸»é¢˜é…ç½®
import { themeConfig } from '../../../config/theme.js';

// è·å–ä¾§è¾¹æ é…ç½®
const sidebarConfig = themeConfig.layout.sidebar;

// å®šä¹‰ä¸‰ä¸ªä¸»è¦èœå•é¡¹
const menuItems = [
  {
    id: 'products',
    title: 'äº§å“',
    icon: 'ğŸ—ï¸',
    mainLink: '/products',
    items: [
      { label: 'æ»‘ç§»è£…è½½æœº', href: '/products/category/skid-steer', count: 12 },
      { label: 'åé“²è£…è½½æœº', href: '/products/category/backhoe', count: 8 },
      { label: 'ä¼¸ç¼©è‡‚è£…è½½æœº', href: '/products/category/telescopic', count: 6 },
      { label: 'ç”µåŠ¨æœºæ¢°', href: '/products/category/electric', count: 4 },
      { label: 'çƒ­é—¨äº§å“', href: '/products/category/hot-selling', count: 15 },
      { label: 'æ–°å“åˆ°è´§', href: '/products/category/new-arrivals', count: 5 },
    ]
  },
  {
    id: 'news',
    title: 'æ–°é—»',
    icon: 'ğŸ“°',
    mainLink: '/news',
    items: [
      { label: 'å…¬å¸æ–°é—»', href: '/news/category/company', count: 25 },
      { label: 'è¡Œä¸šæ–°é—»', href: '/news/category/industry', count: 18 },
      { label: 'äº§å“æ›´æ–°', href: '/news/category/product', count: 12 },
      { label: 'æ´»åŠ¨èµ„è®¯', href: '/news/category/events', count: 8 },
      { label: '2024å¹´', href: '/news/archive/2024', count: 35 },
      { label: '2023å¹´', href: '/news/archive/2023', count: 42 },
    ]
  },
  {
    id: 'cases',
    title: 'æ¡ˆä¾‹',
    icon: 'ğŸ“‹',
    mainLink: '/case',
    items: [
      { label: 'å»ºç­‘é¡¹ç›®', href: '/case/category/construction', count: 20 },
      { label: 'çŸ¿ä¸šä½œä¸š', href: '/case/category/mining', count: 15 },
      { label: 'å†œä¸šåº”ç”¨', href: '/case/category/agriculture', count: 12 },
      { label: 'å¸‚æ”¿é¡¹ç›®', href: '/case/category/municipal', count: 8 },
      { label: 'åŒ—ç¾åœ°åŒº', href: '/case/region/north-america', count: 18 },
      { label: 'æ¬§æ´²åœ°åŒº', href: '/case/region/europe', count: 22 },
      { label: 'äºšå¤ªåœ°åŒº', href: '/case/region/asia-pacific', count: 15 },
    ]
  }
];

// æ ¹æ®é…ç½®æ¨¡å¼å¤„ç†èœå•é¡¹
const getProcessedMenuItems = () => {
  const { displayMode, fixedOrder, autoExpandCurrent } = sidebarConfig;
  
  // ä¸ºæ¯ä¸ªèœå•é¡¹æ·»åŠ çŠ¶æ€ä¿¡æ¯
  const allMenuItems = menuItems.map(menu => ({
    ...menu,
    isActive: menu.id === currentSection,
    defaultOpen: autoExpandCurrent && menu.id === currentSection
  }));

  switch (displayMode) {
    case 'current-top':
      // å½“å‰èœå•é¡¹ç½®é¡¶æ˜¾ç¤º
      return [...allMenuItems].sort((a, b) => {
        if (a.id === currentSection) return -1;
        if (b.id === currentSection) return 1;
        return 0;
      });
      
    case 'fixed-order':
      // å›ºå®šèœå•é¡ºåº
      const orderedItems = [];
      const remainingItems = [...allMenuItems];
      
      // æŒ‰ç…§å›ºå®šé¡ºåºæ’åˆ—
      fixedOrder.forEach(id => {
        const item = remainingItems.find(item => item.id === id);
        if (item) {
          orderedItems.push(item);
          remainingItems.splice(remainingItems.indexOf(item), 1);
        }
      });
      
      // æ·»åŠ å‰©ä½™é¡¹ç›®
      orderedItems.push(...remainingItems);
      return orderedItems;
      
    case 'current-only':
      // åªæ˜¾ç¤ºå½“å‰æ¨¡å—èœå•
      return allMenuItems.filter(item => item.id === currentSection);
      
    default:
      return allMenuItems;
  }
};

const accordionMenus = getProcessedMenuItems();
---

<aside class="accordion-sidebar bg-white rounded-lg shadow-lg overflow-hidden">
  <!-- æ‰‹é£ç´èœå• -->
  <nav class="accordion-nav">
    {accordionMenus.map((menu) => (
      <div class="accordion-section" data-section={menu.id}>
        <div class={`accordion-header-wrapper ${menu.isActive ? 'active' : ''}`}>
          <!-- å¯ç‚¹å‡»çš„æ ‡é¢˜é“¾æ¥åŒºåŸŸ -->
          <a 
            href={menu.mainLink}
            class="accordion-title-link"
          >
            <div class="flex items-center flex-1">
              <span class="text-2xl mr-3">{menu.icon}</span>
              <span class="font-medium">{menu.title}</span>
            </div>
          </a>
          
          <!-- æ‰‹é£ç´åˆ‡æ¢æŒ‰é’® -->
          <button 
            class="accordion-toggle-btn"
            data-accordion-toggle={menu.id}
            aria-expanded={menu.defaultOpen ? 'true' : 'false'}
            aria-label={`å±•å¼€/æŠ˜å  ${menu.title} èœå•`}
          >
            <svg 
              class="accordion-chevron w-6 h-6 transform transition-transform duration-200"
              fill="none" 
              stroke="currentColor" 
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
        </div>
        
        <div 
          class={`accordion-content ${menu.defaultOpen ? 'accordion-open' : ''}`}
          data-accordion-content={menu.id}
        >
          <ul class="accordion-list">
            <!-- å­åˆ†ç±»é“¾æ¥ -->
            {menu.items.map((item) => (
              <li>
                <a 
                  href={item.href}
                  class={`accordion-link ${currentPath === item.href ? 'active' : ''}`}
                >
                  <span class="flex-1">{item.label}</span>
                  {sidebarConfig.showCount && (
                    <span class="accordion-count">({item.count})</span>
                  )}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </div>
    ))}
  </nav>
</aside>

<script>
  // æ‰‹é£ç´åŠŸèƒ½å®ç°
  function initAccordion() {
    const accordionButtons = document.querySelectorAll('.accordion-toggle-btn');
    const { allowMultipleOpen } = JSON.parse(document.querySelector('script[data-sidebar-config]')?.textContent || '{}');
    
    accordionButtons.forEach(button => {
      button.addEventListener('click', function(event) {
        const target = event.currentTarget as HTMLElement;
        const sectionId = target.getAttribute('data-accordion-toggle');
        
        if (!sectionId) return;
        
        const content = document.querySelector(`[data-accordion-content="${sectionId}"]`) as HTMLElement;
        const chevron = target.querySelector('.accordion-chevron') as HTMLElement;
        
        if (!content || !chevron) return;
        
        const isOpen = content.classList.contains('accordion-open');
        
        // å¦‚æœä¸å…è®¸åŒæ—¶å±•å¼€å¤šä¸ªèœå•ï¼Œå…ˆå…³é—­å…¶ä»–èœå•
        if (!allowMultipleOpen && !isOpen) {
          accordionButtons.forEach(otherButton => {
            if (otherButton !== button) {
              const otherSectionId = otherButton.getAttribute('data-accordion-toggle');
              const otherContent = document.querySelector(`[data-accordion-content="${otherSectionId}"]`) as HTMLElement;
              const otherChevron = otherButton.querySelector('.accordion-chevron') as HTMLElement;
              
              if (otherContent && otherChevron) {
                otherContent.classList.remove('accordion-open');
                otherButton.setAttribute('aria-expanded', 'false');
                otherChevron.style.transform = 'rotate(0deg)';
              }
            }
          });
        }
        
        // åˆ‡æ¢å±•å¼€/æŠ˜å çŠ¶æ€
        if (isOpen) {
          content.classList.remove('accordion-open');
          target.setAttribute('aria-expanded', 'false');
          chevron.style.transform = 'rotate(0deg)';
        } else {
          content.classList.add('accordion-open');
          target.setAttribute('aria-expanded', 'true');
          chevron.style.transform = 'rotate(180deg)';
        }
      });
    });
    
    // åˆå§‹åŒ–å±•å¼€çŠ¶æ€
    accordionButtons.forEach(button => {
      const sectionId = button.getAttribute('data-accordion-toggle');
      
      if (!sectionId) return;
      
      const content = document.querySelector(`[data-accordion-content="${sectionId}"]`) as HTMLElement;
      const chevron = button.querySelector('.accordion-chevron') as HTMLElement;
      
      if (!content || !chevron) return;
      
      if (content.classList.contains('accordion-open')) {
        button.setAttribute('aria-expanded', 'true');
        chevron.style.transform = 'rotate(180deg)';
      }
    });
  }
  
  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', initAccordion);
</script>

<!-- ä¼ é€’é…ç½®åˆ°å®¢æˆ·ç«¯ -->
<script data-sidebar-config type="application/json">
  {
    "allowMultipleOpen": ${sidebarConfig.allowMultipleOpen}
  }
</script>

<style>
  .accordion-sidebar {
    @apply sticky top-8;
    max-height: calc(100vh - 2rem);
    overflow-y: auto;
  }
  
  .accordion-section {
    @apply border-b border-gray-100 last:border-b-0;
  }
  
  .accordion-header-wrapper {
    @apply w-full flex items-center justify-between bg-white hover:bg-gray-50 transition-colors duration-200;
  }
  
  .accordion-header-wrapper.active {
    @apply bg-gray-100;
  }
  
  .accordion-title-link {
    @apply flex items-center flex-1 px-5 py-5 text-gray-800 hover:text-gray-700 font-medium text-xl text-left no-underline transition-colors duration-200;
  }
  
  .accordion-title-link:hover {
    @apply text-gray-700;
  }
  
  .accordion-toggle-btn {
    @apply flex items-center justify-center p-3 text-gray-400;
  }
  
  .accordion-toggle-btn:focus {
    @apply outline-none;
  }
  
  .accordion-chevron {
    @apply text-current flex-shrink-0;
  }
  
  .accordion-header-wrapper.active .accordion-chevron {
    @apply text-gray-600;
  }
  
  .accordion-content {
    @apply overflow-hidden transition-all duration-300;
    max-height: 0;
    opacity: 0;
  }
  
  .accordion-content.accordion-open {
    @apply opacity-100;
    max-height: 600px;
  }
  
  .accordion-list {
    @apply py-2 bg-gray-50;
  }
  
  .accordion-link {
    @apply flex items-center justify-between px-6 py-3 text-gray-600 hover:bg-white hover:text-gray-800 transition-colors duration-200 text-lg;
  }
  
  .accordion-link.active {
    @apply bg-white text-gray-800 font-medium;
  }
  
  .accordion-count {
    @apply text-sm text-gray-400 ml-2;
  }
  
  .accordion-link:hover .accordion-count {
    @apply text-gray-600;
  }
  
  .accordion-link.active .accordion-count {
    @apply text-gray-600;
  }
  
  /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
  .accordion-sidebar::-webkit-scrollbar {
    width: 6px;
  }
  
  .accordion-sidebar::-webkit-scrollbar-track {
    @apply bg-gray-100 rounded-full;
  }
  
  .accordion-sidebar::-webkit-scrollbar-thumb {
    @apply bg-gray-300 rounded-full;
  }
  
  .accordion-sidebar::-webkit-scrollbar-thumb:hover {
    @apply bg-gray-400;
  }
  
  /* ç§»åŠ¨è®¾å¤‡é€‚é… */
  @media (max-width: 1024px) {
    .accordion-sidebar {
      @apply static mb-6;
      max-height: none;
    }
    
    .accordion-content.accordion-open {
      max-height: 400px;
    }
  }
  
  /* åŠ¨ç”»æ•ˆæœ */
  .accordion-content.accordion-open {
    animation: slideDown 0.3s ease-out;
  }
  
  @keyframes slideDown {
    from {
      max-height: 0;
      opacity: 0;
    }
    to {
      max-height: 600px;
      opacity: 1;
    }
  }
  
  /* å“åº”å¼å­—ä½“å¤§å° */
  @media (max-width: 640px) {
    .accordion-title-link {
      @apply text-lg px-4 py-4;
    }
    
    .accordion-toggle-btn {
      @apply p-2;
    }
    
    .accordion-link {
      @apply text-base px-5 py-3;
    }
  }
  
  /* ç¬¬ä¸€ä¸ªèœå•é¡¹çš„ç‰¹æ®Šæ ·å¼ */
  .accordion-section:first-child .accordion-header-wrapper {
    @apply border-t-0;
  }
  
  /* æ¿€æ´»çŠ¶æ€çš„åŠ å¼ºè§†è§‰æ•ˆæœ */
  .accordion-header-wrapper.active {
    @apply shadow-sm;
  }
  
  .accordion-header-wrapper.active:hover {
    @apply bg-gray-200;
  }
</style> 