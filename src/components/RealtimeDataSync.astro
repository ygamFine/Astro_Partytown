---
// å®æ—¶æ•°æ®åŒæ­¥ç»„ä»¶ - è§£å†³é™æ€ç«™ç‚¹æ•°æ®æ›´æ–°é—®é¢˜
---

<script type="module">
  // Strapi é…ç½®
  const STRAPI_BASE_URL = 'http://47.251.126.80/api';
  const STRAPI_TOKEN = '2980bc69d09c767b2ca2e1c211a285c9f48985775a3f1d1313025838a611abbfe6d892a29b3417407ddd798d69a9f67f063c27d13827c1765f96b4bc19601295ac11fb9552f4a16ede2745813e3b536827069875ae8c5089a36da57cf69d08b252093e2100e0cc88ac700ca6cd6ebd196f0002bd5fb8219222ed778f8858ad21';
  
  // å­˜å‚¨æ„å»ºæ—¶é—´
  const BUILD_TIME = document.documentElement.getAttribute('data-build-time') || Date.now();
  
  // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ›´æ–°
  async function checkForUpdates() {
    try {
      const response = await fetch(`${STRAPI_BASE_URL}/menus`, {
        headers: {
          'Authorization': `Bearer ${STRAPI_TOKEN}`,
          'Content-Type': 'application/json'
        },
        cache: 'no-cache'
      });
      
      if (!response.ok) {
        console.log('âš ï¸ æ— æ³•è¿æ¥åˆ°Strapi API');
        return false;
      }
      
      const data = await response.json();
      const menus = data.data || [];
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ›´æ–°æ—¶é—´
      const latestUpdate = Math.max(...menus.map(item => 
        new Date(item.updatedAt || item.publishedAt).getTime()
      ));
      
      return latestUpdate > BUILD_TIME;
      
    } catch (error) {
      console.log('âš ï¸ æ•°æ®æ£€æŸ¥å¤±è´¥:', error.message);
      return false;
    }
  }
  
  // æ›´æ–°èœå•æ•°æ®
  async function updateMenuData() {
    try {
      const response = await fetch(`${STRAPI_BASE_URL}/menus`, {
        headers: {
          'Authorization': `Bearer ${STRAPI_TOKEN}`,
          'Content-Type': 'application/json'
        },
        cache: 'no-cache'
      });
      
      if (!response.ok) return false;
      
      const data = await response.json();
      const menus = data.data?.map(item => ({
        name: item.name,
        path: item.path,
        publishedAt: item.publishedAt
      })) || [];
      
      // æ›´æ–°æ¡Œé¢ç«¯èœå•
      const desktopMenu = document.querySelector('.hidden.md\\:flex.items-center.space-x-6');
      if (desktopMenu && menus.length > 0) {
        desktopMenu.innerHTML = menus.map(menu => 
          `<a href="${menu.path}" class="text-gray-700 hover:text-red-600 transition-colors duration-200 font-medium">${menu.name}</a>`
        ).join('');
      }
      
      // æ›´æ–°ç§»åŠ¨ç«¯èœå•
      const mobileMenu = document.getElementById('mobile-smart-menu');
      if (mobileMenu && menus.length > 0) {
        mobileMenu.innerHTML = menus.map(menu => 
          `<a href="${menu.path}" class="block px-3 py-2 text-gray-700 hover:text-red-600 hover:bg-gray-50 rounded-md transition-colors font-medium">${menu.name}</a>`
        ).join('');
      }
      
      // æ˜¾ç¤ºæ›´æ–°æç¤º
      showUpdateNotification(menus.length);
      
      return true;
      
    } catch (error) {
      console.log('âš ï¸ èœå•æ›´æ–°å¤±è´¥:', error.message);
      return false;
    }
  }
  
  // æ˜¾ç¤ºæ•°æ®æ›´æ–°é€šçŸ¥
  function showUpdateNotification(menuCount) {
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = document.createElement('div');
    notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
    notification.innerHTML = `
      <div class="flex items-center space-x-2">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        <span>æ•°æ®å·²æ›´æ–° (${menuCount}ä¸ªèœå•)</span>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
      if (notification.parentNode) {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }, 3000);
  }
  
  // æ˜¾ç¤ºè¿‡æœŸæ•°æ®æç¤º
  function showDataOutdatedNotification() {
    const notification = document.createElement('div');
    notification.className = 'fixed top-20 right-4 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 cursor-pointer';
    notification.innerHTML = `
      <div class="flex items-center space-x-2">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        <span>æ•°æ®å¯èƒ½è¿‡æœŸï¼Œç‚¹å‡»åˆ·æ–°</span>
      </div>
    `;
    
    notification.addEventListener('click', () => {
      window.location.reload();
    });
    
    document.body.appendChild(notification);
    
    // 10ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
      if (notification.parentNode) {
        notification.style.opacity = '0';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }, 10000);
  }
  
  // ä¸»è¦åŒæ­¥é€»è¾‘
  async function syncData() {
    console.log('ğŸ”„ æ£€æŸ¥æ•°æ®æ›´æ–°...');
    
    const hasUpdates = await checkForUpdates();
    
    if (hasUpdates) {
      console.log('ğŸ“¥ å‘ç°æ•°æ®æ›´æ–°ï¼Œæ­£åœ¨åŒæ­¥...');
      const success = await updateMenuData();
      
      if (!success) {
        showDataOutdatedNotification();
      }
    } else {
      console.log('âœ… æ•°æ®å·²æ˜¯æœ€æ–°');
    }
  }
  
  // åˆå§‹åŒ–å®æ—¶åŒæ­¥
  function initRealtimeSync() {
    // è®¾ç½®æ„å»ºæ—¶é—´åˆ°HTML
    if (!document.documentElement.getAttribute('data-build-time')) {
      document.documentElement.setAttribute('data-build-time', Date.now());
    }
    
    // é¡µé¢åŠ è½½åç«‹å³æ£€æŸ¥ä¸€æ¬¡
    setTimeout(syncData, 2000);
    
    // æ¯2åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ›´æ–°
    setInterval(syncData, 120000);
    
    // é¡µé¢ç„¦ç‚¹æ¢å¤æ—¶æ£€æŸ¥æ›´æ–°
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        setTimeout(syncData, 1000);
      }
    });
    
    console.log('ğŸš€ å®æ—¶æ•°æ®åŒæ­¥å·²å¯åŠ¨');
  }
  
  // DOMåŠ è½½å®Œæˆåå¯åŠ¨
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRealtimeSync);
  } else {
    initRealtimeSync();
  }
</script>

<!-- åœ¨HTMLä¸­æ ‡è®°æ„å»ºæ—¶é—´ -->
<script is:inline>
  document.documentElement.setAttribute('data-build-time', Date.now());
</script> 