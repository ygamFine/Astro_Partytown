---
// SSG标准数据同步组件 - 显示数据更新提示
---

<script type="module">
  // 公共API endpoint (无需Token的只读接口)
  const PUBLIC_API_BASE = 'http://47.251.126.80/api';
  
  // 存储构建时间
  const BUILD_TIME = document.documentElement.getAttribute('data-build-time') || Date.now();
  
  // 检查数据是否有更新 (使用公共API)
  async function checkForUpdates() {
    try {
      // 尝试访问公共API，不使用Token
      const response = await fetch(`${PUBLIC_API_BASE}/menus?populate=*`, {
        method: 'GET',
        cache: 'no-cache'
      });
      
      if (!response.ok) {
        console.log('⚠️ 无法连接到API，可能需要刷新页面');
        return false;
      }
      
      const data = await response.json();
      const menus = data.data || [];
      
      if (menus.length === 0) {
        console.log('⚠️ 未获取到菜单数据');
        return false;
      }
      
      // 检查是否有新的更新时间
      const latestUpdate = Math.max(...menus.map(item => 
        new Date(item.updatedAt || item.publishedAt).getTime()
      ));
      
      return latestUpdate > BUILD_TIME;
      
    } catch (error) {
      console.log('⚠️ 数据检查失败，建议刷新页面:', error.message);
      return false;
    }
  }
  
  // SSG标准：不直接更新数据，而是提示用户刷新
  function showRefreshNotification() {
    const notification = document.createElement('div');
    notification.className = 'fixed top-20 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 cursor-pointer transition-all duration-300';
    notification.innerHTML = `
      <div class="flex items-center space-x-2">
        <svg class="w-5 h-5 animate-spin" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
        </svg>
        <span>发现数据更新，点击刷新</span>
      </div>
    `;
    
    notification.addEventListener('click', () => {
      window.location.reload();
    });
    
    document.body.appendChild(notification);
    
    // 30秒后自动消失
    setTimeout(() => {
      if (notification.parentNode) {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }, 30000);
  }
  

  
  // SSG标准同步逻辑
  async function syncData() {
    console.log('🔄 检查数据更新...');
    
    const hasUpdates = await checkForUpdates();
    
    if (hasUpdates) {
      console.log('📥 发现数据更新，提示用户刷新页面');
      showRefreshNotification();
    } else {
      console.log('✅ 数据已是最新');
    }
  }
  
  // 初始化SSG标准数据检查
  function initDataChecker() {
    // 设置构建时间到HTML
    if (!document.documentElement.getAttribute('data-build-time')) {
      document.documentElement.setAttribute('data-build-time', Date.now());
    }
    
    // 页面加载后5秒检查一次 (避免影响性能)
    setTimeout(syncData, 5000);
    
    // 每10分钟检查一次更新 (符合SSG实践)
    setInterval(syncData, 600000);
    
    // 页面焦点恢复时检查更新 (用户重新访问时)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        setTimeout(syncData, 3000);
      }
    });
    
    console.log('🚀 SSG数据检查器已启动');
  }
  
  // DOM加载完成后启动
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDataChecker);
  } else {
    initDataChecker();
  }
</script>

<!-- 在HTML中标记构建时间 -->
<script is:inline>
  document.documentElement.setAttribute('data-build-time', Date.now());
</script> 