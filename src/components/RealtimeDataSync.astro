---
// çº¯SSGæ•°æ®æ›´æ–°æ£€æŸ¥ç»„ä»¶ - ä»…æç¤ºï¼Œä¸ä¿®æ”¹DOM
---

<script type="module">
  // æ„å»ºæ—¶é—´æˆ³ (ç”¨äºæ¯”è¾ƒæ•°æ®æ–°æ—§)
  const BUILD_TIME = document.documentElement.getAttribute('data-build-time') || Date.now();
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®æ›´æ–° (çº¯SSGæ–¹å¼)
  async function checkForUpdates() {
    try {
      // å°è¯•è®¿é—®Strapiå…¬å…±API (å¦‚æœå¯ç”¨)
      const response = await fetch('http://47.251.126.80/api/menus?populate=*', {
        method: 'GET',
        cache: 'no-cache',
        mode: 'cors'
      });
      
      if (!response.ok) {
        console.log('âš ï¸ æ— æ³•è¿æ¥åˆ°Strapi APIï¼Œå»ºè®®åˆ·æ–°é¡µé¢');
        return false;
      }
      
      const data = await response.json();
      const menus = data.data || [];
      
      if (!Array.isArray(menus) || menus.length === 0) {
        console.log('âš ï¸ æœªè·å–åˆ°èœå•æ•°æ®');
        return false;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ›´æ–°æ—¶é—´
      const latestUpdate = Math.max(...menus.map(item => 
        new Date(item.updatedAt || item.publishedAt).getTime()
      ));
      
      return latestUpdate > BUILD_TIME;
      
    } catch (error) {
      console.log('âš ï¸ æ•°æ®æ£€æŸ¥å¤±è´¥ï¼Œå»ºè®®åˆ·æ–°é¡µé¢:', error.message);
      return false;
    }
  }
  
  // SSGæ ‡å‡†ï¼šä¸ç›´æ¥æ›´æ–°æ•°æ®ï¼Œè€Œæ˜¯æç¤ºç”¨æˆ·åˆ·æ–°
  function showRefreshNotification() {
    const notification = document.createElement('div');
    notification.className = 'fixed top-20 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 cursor-pointer transition-all duration-300';
    notification.innerHTML = `
      <div class="flex items-center space-x-2">
        <svg class="w-5 h-5 animate-spin" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
        </svg>
        <span>å‘ç°æ•°æ®æ›´æ–°ï¼Œç‚¹å‡»åˆ·æ–°</span>
      </div>
    `;
    
    notification.addEventListener('click', () => {
      window.location.reload();
    });
    
    document.body.appendChild(notification);
    
    // 30ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
      if (notification.parentNode) {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }, 30000);
  }
  

  
  // æ˜¾ç¤ºSSGæ¨¡å¼ä¿¡æ¯
  function showSSGInfo() {
    console.log(`
ğŸ—ï¸ é™æ€ç«™ç‚¹ç”Ÿæˆæ¨¡å¼ (SSG)
âœ… æ„å»ºæ—¶é—´: ${new Date(BUILD_TIME).toLocaleString()}
âœ… æ‰€æœ‰å†…å®¹åœ¨æ„å»ºæ—¶é¢„ç”Ÿæˆ
âœ… æ•°æ®æ›´æ–°é€šè¿‡é‡æ–°æ„å»ºç½‘ç«™å®ç°
â° æ¯10åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥å¹¶é‡æ–°æ„å»º
    `);
  }
  
  // SSGåŒæ­¥é€»è¾‘ (ä»…æ£€æŸ¥å’Œæç¤º)
  async function checkDataUpdates() {
    console.log('ğŸ”„ SSGæ¨¡å¼ï¼šæ£€æŸ¥æ•°æ®æ›´æ–°...');
    
    const hasUpdates = await checkForUpdates();
    
    if (hasUpdates) {
      console.log('ğŸ“¥ å‘ç°æ•°æ®æ›´æ–°ï¼Œå»ºè®®åˆ·æ–°é¡µé¢è·å–æœ€æ–°æ„å»ºç‰ˆæœ¬');
      showRefreshNotification();
    } else {
      console.log('âœ… å½“å‰æ˜¾ç¤ºçš„æ˜¯æœ€æ–°æ•°æ®');
    }
  }
  
  // åˆå§‹åŒ–SSGæ•°æ®æ£€æŸ¥å™¨
  function initSSGChecker() {
    // æ˜¾ç¤ºSSGæ¨¡å¼ä¿¡æ¯
    showSSGInfo();
    
    // è®¾ç½®æ„å»ºæ—¶é—´æ ‡è®°
    if (!document.documentElement.getAttribute('data-build-time')) {
      document.documentElement.setAttribute('data-build-time', Date.now());
    }
    
    // å»¶è¿Ÿæ£€æŸ¥ (ä¸å½±å“é¦–å±æ€§èƒ½)
    setTimeout(checkDataUpdates, 10000);
    
    // å®šæœŸæ£€æŸ¥ (é¢‘ç‡è¾ƒä½ï¼Œç¬¦åˆSSGå®è·µ)
    setInterval(checkDataUpdates, 900000); // 15åˆ†é’Ÿ
    
    // ç”¨æˆ·é‡æ–°è®¿é—®æ—¶æ£€æŸ¥
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        setTimeout(checkDataUpdates, 5000);
      }
    });
    
    console.log('ğŸš€ SSGæ•°æ®æ£€æŸ¥å™¨å·²å¯åŠ¨');
  }
  
  // DOMåŠ è½½å®Œæˆåå¯åŠ¨
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSSGChecker);
  } else {
    initSSGChecker();
  }
</script>

<!-- åœ¨HTMLä¸­æ ‡è®°æ„å»ºæ—¶é—´ -->
<script is:inline>
  document.documentElement.setAttribute('data-build-time', Date.now());
</script> 