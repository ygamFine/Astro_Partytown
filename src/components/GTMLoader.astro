---
// ç¯å¢ƒæ£€æµ‹
const isProd = import.meta.env.PROD;
const isDev = import.meta.env.DEV;
const mode = import.meta.env.MODE;

// GTMé…ç½®
const GTM_ID = 'GTM-5MNNZB76'; // æ›¿æ¢æˆä½ çš„ GTM ID

// è°ƒè¯•ä¿¡æ¯
console.log(`ğŸ”§ GTM Loader - ç¯å¢ƒ: ${mode}, ç”Ÿäº§æ¨¡å¼: ${isProd}, GTM ID: ${GTM_ID}`);
---

<!-- ğŸ¯ æ™ºèƒ½GTMåŠ¨æ€åŠ è½½å™¨ - æ”¯æŒURLå‚æ•°æ§åˆ¶ -->
<script is:inline define:vars={{ isProd, isDev, GTM_ID }}>
  (function() {
    // ğŸ” è¿è¡Œæ—¶ç¯å¢ƒå’Œå‚æ•°æ£€æµ‹
    const urlParams = new URLSearchParams(window.location.search);
    const hasGTMDebug = urlParams.has('gtm_debug');
    const hasGTMPreview = urlParams.has('gtm_preview');
    const gtmAuth = urlParams.get('gtm_auth') || '';
    const gtmPreview = urlParams.get('gtm_preview') || '';
    
    // ğŸ§  æ™ºèƒ½æ¨¡å¼åˆ¤æ–­
    const forceDebugMode = hasGTMDebug || hasGTMPreview;
    const usePartytown = isProd && !forceDebugMode;
    const isDebugMode = isDev || forceDebugMode;
    
    console.log(`ğŸ”§ [GTM] è¿è¡Œæ¨¡å¼: ${usePartytown ? 'Partytown' : 'Standard'}`);
    console.log(`ğŸ”§ [GTM] è°ƒè¯•æ¨¡å¼: ${isDebugMode ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
    console.log(`ğŸ”§ [GTM] URLå‚æ•°: debug=${hasGTMDebug}, preview=${hasGTMPreview}`);

    // åˆå§‹åŒ– dataLayer
    window.dataLayer = window.dataLayer || [];
    
    // æ·»åŠ ç¯å¢ƒå’Œå‚æ•°ä¿¡æ¯åˆ°æ•°æ®å±‚
    window.dataLayer.push({
      'environment': isProd ? 'production' : 'development',
      'gtm_mode': usePartytown ? 'partytown' : 'standard',
      'debug_mode': isDebugMode,
      'url_debug': hasGTMDebug,
      'url_preview': hasGTMPreview,
      'gtm.start': new Date().getTime(),
      'event': 'gtm.js'
    });

    // ğŸ› ï¸ è°ƒè¯•å·¥å…·å’Œç›‘å¬ï¼ˆè°ƒè¯•æ¨¡å¼ä¸‹ï¼‰
    if (isDebugMode) {
      console.log('ğŸ› [GTM Debug] DataLayer å·²åˆå§‹åŒ–:', window.dataLayer);
      
      // ç›‘å¬ dataLayer å˜åŒ–
      const originalPush = window.dataLayer.push;
      window.dataLayer.push = function(...args) {
        console.log('ğŸ› [GTM Debug] DataLayer Push:', args);
        return originalPush.apply(this, args);
      };

      // åˆ›å»ºè°ƒè¯•åŠ©æ‰‹
      window.gtmDebug = {
        push: (data) => {
          console.log('ğŸ§ª [GTM Debug] æ‰‹åŠ¨æ¨é€äº‹ä»¶:', data);
          window.dataLayer.push(data);
        },
        getDataLayer: () => {
          console.log('ğŸ§ª [GTM Debug] å½“å‰ dataLayer:', window.dataLayer);
          return window.dataLayer;
        },
        testEvent: () => {
          const testData = {
            event: 'test_event',
            event_category: 'development',
            event_action: 'manual_test',
            event_label: 'gtm_debug_helper',
            timestamp: new Date().toISOString()
          };
          window.dataLayer.push(testData);
          console.log('ğŸ§ª [GTM Debug] æµ‹è¯•äº‹ä»¶å·²å‘é€:', testData);
        },
        reload: () => {
          console.log('ğŸ”„ [GTM Debug] é‡æ–°åŠ è½½GTM...');
          location.reload();
        }
      };
      
      console.log('ğŸ§ª [GTM Debug] è°ƒè¯•åŠ©æ‰‹å·²åŠ è½½ï¼Œå¯ç”¨å‘½ä»¤:');
      console.log('  - gtmDebug.push(data)     // æ¨é€è‡ªå®šä¹‰äº‹ä»¶');
      console.log('  - gtmDebug.getDataLayer() // æŸ¥çœ‹æ•°æ®å±‚');
      console.log('  - gtmDebug.testEvent()    // å‘é€æµ‹è¯•äº‹ä»¶');
      console.log('  - gtmDebug.reload()       // é‡æ–°åŠ è½½é¡µé¢');
    }

    // ğŸš€ åŠ¨æ€åˆ›å»ºGTMè„šæœ¬
    function createGTMScript() {
      // æ„å»ºGTM URLå‚æ•°
      let gtmParams = '';
      if (isDebugMode) {
        gtmParams += '&gtm_debug=true';
      }
      if (gtmAuth) {
        gtmParams += `&gtm_auth=${gtmAuth}`;
      }
      if (gtmPreview) {
        gtmParams += `&gtm_preview=${gtmPreview}`;
      }

      // åˆ›å»ºè„šæœ¬å†…å®¹
      const scriptContent = `
        (function(w,d,s,l,i){
          w[l]=w[l]||[];
          var f=d.getElementsByTagName(s)[0],
              j=d.createElement(s),
              dl=l!='dataLayer'?'&l='+l:'';
          j.async=true;
          j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl+'${gtmParams}';
          
          j.onload=function(){
            const mode = '${usePartytown ? 'Partytown' : 'Standard'}';
            console.log('âœ… [GTM] GTMè„šæœ¬åŠ è½½æˆåŠŸ (' + mode + ' æ¨¡å¼)');
            ${isDebugMode ? `
            setTimeout(() => {
              if (window.google_tag_manager) {
                console.log('ğŸ” [GTM Debug] GTMå®¹å™¨ä¿¡æ¯:', Object.keys(window.google_tag_manager));
              }
            }, 1000);
            ` : ''}
          };
          
          j.onerror=function(e){
            console.error('âŒ [GTM] GTMè„šæœ¬åŠ è½½å¤±è´¥:', e);
            ${isDebugMode ? `
            console.warn('ğŸ’¡ [GTM Debug] å¯èƒ½çš„åŸå› :');
            console.warn('  - ç½‘ç»œè¿æ¥é—®é¢˜');
            console.warn('  - GTMå®¹å™¨IDé”™è¯¯');
            console.warn('  - CORSé™åˆ¶ï¼ˆ${usePartytown ? 'Partytownæ¨¡å¼' : 'æ ‡å‡†æ¨¡å¼'}ï¼‰');
            ` : ''}
          };
          
          f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','${GTM_ID}');
      `;

      // åˆ›å»ºè„šæœ¬å…ƒç´ 
      const script = document.createElement('script');
      script.type = usePartytown ? 'text/partytown' : 'text/javascript';
      script.innerHTML = scriptContent;

      // æ·»åŠ åˆ°é¡µé¢
      document.head.appendChild(script);

      console.log(`ğŸš€ [GTM] è„šæœ¬å·²åˆ›å»º (ç±»å‹: ${script.type})`);
    }

    // ğŸƒâ€â™‚ï¸ ç«‹å³æ‰§è¡Œæˆ–ç­‰å¾…åŠ è½½å®Œæˆ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', createGTMScript);
    } else {
      createGTMScript();
    }

  })();
</script>

<!-- ğŸ¯ æ™ºèƒ½noscriptå›é€€ - æ”¯æŒæ‰€æœ‰æ¨¡å¼ -->
<!-- <script is:inline define:vars={{ GTM_ID }}>
  // åˆ›å»ºnoscriptå›é€€
  (function() {
    const noscript = document.createElement('noscript');
    const iframe = document.createElement('iframe');
    
    // æ£€æŸ¥URLå‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const gtmAuth = urlParams.get('gtm_auth') || '';
    const gtmPreview = urlParams.get('gtm_preview') || '';
    
    // æ„å»ºiframeå‚æ•°
    let iframeParams = '';
    if (gtmAuth) iframeParams += `&gtm_auth=${gtmAuth}`;
    if (gtmPreview) iframeParams += `&gtm_preview=${gtmPreview}`;
    
    iframe.src = `https://www.googletagmanager.com/ns.html?id=${GTM_ID}${iframeParams}`;
    iframe.height = '0';
    iframe.width = '0';
    iframe.style.display = 'none';
    iframe.style.visibility = 'hidden';
    iframe.title = 'Google Tag Manager';
    
    noscript.appendChild(iframe);
    document.head.appendChild(noscript);
  })();
</script> -->

<!-- ğŸ” GTM æœ€ç»ˆéªŒè¯æ£€æŸ¥ -->
<script is:inline>
  // é¡µé¢åŠ è½½å®Œæˆåçš„æœ€ç»ˆéªŒè¯
  window.addEventListener('load', function() {
    setTimeout(() => {
      const urlParams = new URLSearchParams(window.location.search);
      const isDebugMode = urlParams.has('gtm_debug') || urlParams.has('gtm_preview');
      
      if (window.dataLayer && window.dataLayer.length > 0) {
        console.log('âœ… [GTM] é…ç½®éªŒè¯é€šè¿‡ - DataLayerå·²åˆå§‹åŒ–');
        
        if (isDebugMode) {
          console.log('ğŸ” [GTM Debug] æœ€ç»ˆéªŒè¯ - DataLayerå†…å®¹:', window.dataLayer);
          if (window.google_tag_manager) {
            console.log('ğŸ” [GTM Debug] GTMç®¡ç†å™¨çŠ¶æ€: loaded');
            console.log('ğŸ” [GTM Debug] å®¹å™¨æ•°é‡:', Object.keys(window.google_tag_manager).length);
          } else {
            console.warn('âš ï¸ [GTM Debug] GTMç®¡ç†å™¨å°šæœªå®Œå…¨åŠ è½½');
          }
        }
      } else {
        console.error('âŒ [GTM] éªŒè¯å¤±è´¥ - DataLayeræœªæ­£ç¡®åˆå§‹åŒ–');
      }
    }, 3000);
  });
</script>

<style>
  /* ğŸ¨ GTMç»„ä»¶æ ·å¼ä¼˜åŒ– */
  noscript iframe {
    position: absolute !important;
    top: -9999px !important;
    left: -9999px !important;
    width: 0 !important;
    height: 0 !important;
    border: none !important;
    visibility: hidden !important;
    display: none !important;
  }
</style> 