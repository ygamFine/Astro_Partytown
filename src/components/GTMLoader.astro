---
// ç¯å¢ƒæ£€æµ‹
const isProd = import.meta.env.PROD;
const isDev = import.meta.env.DEV;
const mode = import.meta.env.MODE;

// GTMé…ç½®
const GTM_ID = 'GTM-5MNNZB76';
const GTM_DEBUG = isDev ? '&gtm_debug=true' : '';
const GTM_PREVIEW = isDev ? '&gtm_preview=' : '';

// è°ƒè¯•ä¿¡æ¯
console.log(`ğŸ”§ GTM Loader - ç¯å¢ƒ: ${mode}, ç”Ÿäº§æ¨¡å¼: ${isProd}, GTM ID: ${GTM_ID}`);
---

<!-- GTM æ•°æ®å±‚åˆå§‹åŒ– -->
<script is:inline define:vars={{ isProd, isDev, GTM_ID }}>
  // åˆå§‹åŒ– dataLayer
  window.dataLayer = window.dataLayer || [];
  
  // æ·»åŠ ç¯å¢ƒä¿¡æ¯åˆ°æ•°æ®å±‚
  window.dataLayer.push({
    'environment': isProd ? 'production' : 'development',
    'gtm.start': new Date().getTime(),
    'event': 'gtm.js'
  });
  
  // å¼€å‘ç¯å¢ƒè°ƒè¯•ä¿¡æ¯
  if (isDev) {
    console.log('ğŸ› [GTM Debug] DataLayer å·²åˆå§‹åŒ–:', window.dataLayer);
    
    // ç›‘å¬ dataLayer å˜åŒ–ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
    const originalPush = window.dataLayer.push;
    window.dataLayer.push = function(...args) {
      console.log('ğŸ› [GTM Debug] DataLayer Push:', args);
      return originalPush.apply(this, args);
    };
  }
</script>

{isProd ? (
  <!-- âœ… ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ Partytown åŠ è½½ GTM -->
  <>
    <script type="text/partytown" define:vars={{ GTM_ID }}>
      (function(w,d,s,l,i){
        // ç¡®ä¿ dataLayer å­˜åœ¨
        w[l] = w[l] || [];
        
        // åˆ›å»º GTM è„šæœ¬æ ‡ç­¾
        var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != 'dataLayer' ? '&l=' + l : '';
            
        j.async = true;
        j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        j.onerror = function() {
          console.error('âŒ [GTM] Failed to load GTM script in production');
        };
        j.onload = function() {
          console.log('âœ… [GTM] GTM script loaded successfully in production via Partytown');
        };
        
        f.parentNode.insertBefore(j, f);
      })(window, document, 'script', 'dataLayer', GTM_ID);
    </script>
    
    <!-- noscript fallback for production -->
    <noscript>
      <iframe 
        src={`https://www.googletagmanager.com/ns.html?id=${GTM_ID}`}
        height="0" 
        width="0" 
        style="display:none;visibility:hidden"
        title="Google Tag Manager"
      ></iframe>
    </noscript>
  </>
) : (
  <!-- ğŸ§ª å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨æ ‡å‡† script åŠ è½½ GTM -->
  <>
    <script is:inline define:vars={{ GTM_ID, GTM_DEBUG, GTM_PREVIEW }}>
      (function(w,d,s,l,i){
        // ç¡®ä¿ dataLayer å­˜åœ¨
        w[l] = w[l] || [];
        
        // å¼€å‘ç¯å¢ƒç‰¹æ®Šå¤„ç†
        console.log('ğŸ§ª [GTM Dev] å¼€å§‹åŠ è½½ GTM è„šæœ¬...');
        
        // åˆ›å»º GTM è„šæœ¬æ ‡ç­¾
        var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != 'dataLayer' ? '&l=' + l : '';
            
        j.async = true;
        j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl + GTM_DEBUG + GTM_PREVIEW;
        
        // å¼€å‘ç¯å¢ƒé”™è¯¯å¤„ç†
        j.onerror = function(e) {
          console.error('âŒ [GTM Dev] GTM è„šæœ¬åŠ è½½å¤±è´¥:', e);
          console.warn('ğŸ’¡ [GTM Dev] è¿™åœ¨å¼€å‘ç¯å¢ƒæ˜¯æ­£å¸¸çš„ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–CORSé™åˆ¶');
        };
        
        j.onload = function() {
          console.log('âœ… [GTM Dev] GTM è„šæœ¬åŠ è½½æˆåŠŸ');
          console.log('ğŸ” [GTM Dev] GTM Debug æ¨¡å¼å·²å¯ç”¨');
          
          // å¼€å‘ç¯å¢ƒé¢å¤–è°ƒè¯•ä¿¡æ¯
          setTimeout(() => {
            if (window.google_tag_manager) {
              console.log('ğŸ” [GTM Dev] GTM å®¹å™¨ä¿¡æ¯:', Object.keys(window.google_tag_manager));
            }
          }, 1000);
        };
        
        f.parentNode.insertBefore(j, f);
      })(window, document, 'script', 'dataLayer', GTM_ID);
    </script>
    
    <!-- å¼€å‘ç¯å¢ƒ noscript fallback -->
    <noscript>
      <iframe 
        src={`https://www.googletagmanager.com/ns.html?id=${GTM_ID}${GTM_DEBUG}${GTM_PREVIEW}`}
        height="0" 
        width="0" 
        style="display:none;visibility:hidden"
        title="Google Tag Manager (Dev)"
      ></iframe>
    </noscript>
    
    <!-- å¼€å‘ç¯å¢ƒè°ƒè¯•é¢æ¿ -->
    <script is:inline>
      // å¼€å‘ç¯å¢ƒ GTM è°ƒè¯•åŠ©æ‰‹
      if (typeof window !== 'undefined') {
        window.gtmDebug = {
          // æ‰‹åŠ¨è§¦å‘äº‹ä»¶
          push: (data) => {
            console.log('ğŸ§ª [GTM Debug] æ‰‹åŠ¨æ¨é€äº‹ä»¶:', data);
            window.dataLayer.push(data);
          },
          
          // æŸ¥çœ‹å½“å‰ dataLayer
          getDataLayer: () => {
            console.log('ğŸ§ª [GTM Debug] å½“å‰ dataLayer:', window.dataLayer);
            return window.dataLayer;
          },
          
          // æµ‹è¯•äº‹ä»¶
          testEvent: () => {
            const testData = {
              event: 'test_event',
              event_category: 'development',
              event_action: 'manual_test',
              event_label: 'gtm_debug_helper',
              timestamp: new Date().toISOString()
            };
            window.dataLayer.push(testData);
            console.log('ğŸ§ª [GTM Debug] æµ‹è¯•äº‹ä»¶å·²å‘é€:', testData);
          }
        };
        
        console.log('ğŸ§ª [GTM Debug] è°ƒè¯•åŠ©æ‰‹å·²åŠ è½½ï¼Œå¯ç”¨å‘½ä»¤:');
        console.log('  - gtmDebug.push(data)     // æ¨é€è‡ªå®šä¹‰äº‹ä»¶');
        console.log('  - gtmDebug.getDataLayer() // æŸ¥çœ‹æ•°æ®å±‚');
        console.log('  - gtmDebug.testEvent()    // å‘é€æµ‹è¯•äº‹ä»¶');
      }
    </script>
  </>
)}

<!-- é€šç”¨ GTM é…ç½®æ£€æŸ¥ -->
<script is:inline define:vars={{ isProd, isDev }}>
  // é¡µé¢åŠ è½½å®Œæˆåçš„éªŒè¯
  window.addEventListener('load', function() {
    setTimeout(() => {
      // æ£€æŸ¥ GTM æ˜¯å¦æ­£ç¡®åŠ è½½
      if (window.dataLayer) {
        const mode = isProd ? 'ç”Ÿäº§' : 'å¼€å‘';
        console.log(`âœ… [GTM] ${mode}ç¯å¢ƒ GTM é…ç½®éªŒè¯é€šè¿‡`);
        
        if (isDev) {
          console.log('ğŸ” [GTM Dev] DataLayer å†…å®¹:', window.dataLayer);
          if (window.google_tag_manager) {
            console.log('ğŸ” [GTM Dev] GTM ç®¡ç†å™¨çŠ¶æ€:', 'loaded');
          } else {
            console.warn('âš ï¸ [GTM Dev] GTM ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¿™åœ¨å¼€å‘ç¯å¢ƒæ˜¯å¸¸è§çš„');
          }
        }
      } else {
        console.error('âŒ [GTM] DataLayer æœªåˆå§‹åŒ–ï¼');
      }
    }, 2000);
  });
</script>

<style>
  /* ç¡®ä¿ noscript iframe ä¸å½±å“å¸ƒå±€ */
  noscript iframe {
    position: absolute;
    top: -9999px;
    left: -9999px;
  }
</style> 