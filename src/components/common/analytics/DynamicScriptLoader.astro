---
// ç¯å¢ƒæ£€æµ‹
const isProd = import.meta.env.PROD;
const isDev = import.meta.env.DEV;

// ç»„ä»¶å±æ€§
export interface Props {
  position: 'header' | 'body-top' | 'body-bottom';
  pageType?: string;
  route?: string;
  loadCondition?: boolean;
}

const {
  position,
  pageType = 'default',
  route = '',
  loadCondition = true
} = Astro.props;

// Strapi API é…ç½®
const STRAPI_API_URL = 'http://182.92.233.160:1137/api/insert-code';

// è·å–åŠ¨æ€è„šæœ¬æ•°æ® - åœ¨æ„å»ºæ—¶æ‰§è¡Œ
let dynamicScripts = null;
let error = null;

// æŒ‰éœ€åŠ è½½æ¡ä»¶æ£€æŸ¥
const shouldLoadScripts = loadCondition && (
  pageType !== 'none' && 
  route !== 'excluded'
);

if (shouldLoadScripts) {
  try {
    const response = await fetch(STRAPI_API_URL, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¼“å­˜ï¼Œå¼€å‘ç¯å¢ƒå®æ—¶è·å–
      cache: isProd ? 'force-cache' : 'no-store'
    });

    if (response.ok) {
      const data = await response.json();
      dynamicScripts = data.data;
    } else {
      error = `API è¯·æ±‚å¤±è´¥: ${response.status}`;
      console.error('åŠ¨æ€è„šæœ¬åŠ è½½å™¨é”™è¯¯:', error);
    }
  } catch (err: any) {
    error = `è·å–åŠ¨æ€è„šæœ¬å¤±è´¥: ${err.message}`;
    console.error('åŠ¨æ€è„šæœ¬åŠ è½½å™¨é”™è¯¯:', error);
  }
}

// æ ¹æ®ä½ç½®è¿‡æ»¤è„šæœ¬å†…å®¹
const getScriptsByPosition = (scripts: any, pos: string) => {
  if (!scripts) return null;
  
  switch (pos) {
    case 'header':
      return {
        meta: scripts.header_label_meta,
        css: scripts.header_label_css,
        scripts: scripts.header_label_scripts
      };
    case 'body-top':
      return {
        css: scripts.body_label_top_css,
        scripts: scripts.body_label_top_css_scripts
      };
    case 'body-bottom':
      return {
        css: scripts.body_label_bottom_css,
        scripts: scripts.body_label_bottom_scripts
      };
    default:
      return null;
  }
};

// è·å–å½“å‰ä½ç½®çš„è„šæœ¬
const currentScripts = dynamicScripts ? getScriptsByPosition(dynamicScripts, position) : null;

// å¼€å‘ç¯å¢ƒè°ƒè¯•ä¿¡æ¯
if (isDev && currentScripts) {
  console.log(`ğŸ¯ åŠ¨æ€è„šæœ¬åŠ è½½å™¨ [${position}] - å·²åŠ è½½è„šæœ¬:`, {
    pageType,
    route,
    hasScripts: !!currentScripts.scripts,
    hasStyles: !!currentScripts.css,
    hasMeta: !!currentScripts.meta
  });
}
---

<!-- ğŸ¯ åŠ¨æ€è„šæœ¬åŠ è½½å™¨ - ä½ç½®: {position} -->
{currentScripts && (
  <>
    <!-- ğŸ“ Meta æ ‡ç­¾ (ä»… header ä½ç½®) -->
    {position === 'header' && currentScripts.meta && (
      <Fragment set:html={currentScripts.meta} />
    )}

    <!-- ğŸ¨ CSS æ ·å¼ -->
    {currentScripts.css && (
      <Fragment set:html={currentScripts.css} />
    )}

    <!-- ğŸ“œ JavaScript è„šæœ¬ -->
    {currentScripts.scripts && (
      <Fragment set:html={currentScripts.scripts} />
    )}
  </>
)}

<!-- å¼€å‘ç¯å¢ƒé”™è¯¯æç¤º -->
{isDev && error && (
  <script define:vars={{ error, position, pageType, route }}>
    console.warn(`ğŸ¯ åŠ¨æ€è„šæœ¬åŠ è½½å™¨ [${position}] è­¦å‘Š:`, error, { pageType, route });
  </script>
)}
