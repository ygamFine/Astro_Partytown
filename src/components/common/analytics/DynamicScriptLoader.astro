---
// 环境检测
const isProd = import.meta.env.PROD;
const isDev = import.meta.env.DEV;
// 优先读服务端环境变量，其次读公开前缀（用于浏览器端兜底）
const STRAPI_STATIC_URL = (typeof process !== 'undefined' ? process.env.STRAPI_STATIC_URL : '') || import.meta.env.STRAPI_STATIC_URL || '';
// 生产构建缺省禁用动态脚本获取；如需开启，设置 ENABLE_DYNAMIC_SCRIPTS=true 或 PUBLIC_ENABLE_DYNAMIC_SCRIPTS=true
const ENABLE_DYNAMIC_SCRIPTS = (
  (typeof process !== 'undefined' ? process.env.ENABLE_DYNAMIC_SCRIPTS : '') === 'true'
  || import.meta.env.PUBLIC_ENABLE_DYNAMIC_SCRIPTS === 'true'
);
const allowDynamicFetch = isDev || ENABLE_DYNAMIC_SCRIPTS;

// 组件属性
export interface Props {
  position: 'header' | 'body-top' | 'body-bottom';
  pageType?: string;
  route?: string;
  loadCondition?: boolean;
  lang?: string;
}

const {
  position,
  pageType = 'default',
  route = '',
  loadCondition = true,
  lang = 'en'
} = Astro.props;

// 🚀 智能优化策略 - 基于位置和脚本类型
const getOptimizationStrategy = () => {
  // Body Bottom 位置使用 Partytown，其他位置使用标准脚本
  if (position === 'body-bottom') {
    return { 
      usePartytown: true,
      useLazyLoad: true,
      useAsync: true
    };
  }
  return { 
    usePartytown: false,
    useLazyLoad: false,
    useAsync: false
  };
};

const optimization = getOptimizationStrategy();

// Strapi API 配置（缺少基址时直接跳过加载，避免 undefined/... 报错）
const STRAPI_API_URL = STRAPI_STATIC_URL ? `${STRAPI_STATIC_URL}/api/insert-code` : '';

// 获取动态脚本数据 - 在构建时执行
let dynamicScripts = null;
let error = null;

// 按需加载条件检查（仅开发或显式开启时才会在构建期触发远程获取）
const shouldLoadScripts = allowDynamicFetch && loadCondition && STRAPI_API_URL && (
  pageType !== 'none' && 
  route !== 'excluded'
);

if (shouldLoadScripts) {
  try {
    const response = await fetch(STRAPI_API_URL, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        ...(process.env.STRAPI_API_TOKEN ? { 'Authorization': `Bearer ${process.env.STRAPI_API_TOKEN}` } : {})
      },
      // 生产环境使用缓存，开发环境实时获取
      cache: isProd ? 'force-cache' : 'no-store'
    });

    if (response.ok) {
      const data = await response.json();
      dynamicScripts = data.data;
    } else {
      error = `API 请求失败: ${response.status}`;
      if (isDev) console.error('动态脚本加载器错误:', error);
    }
  } catch (err: any) {
    error = `获取动态脚本失败: ${err.message}`;
    if (isDev) console.error('动态脚本加载器错误:', error);
  }
}

// 根据位置过滤脚本内容
const getScriptsByPosition = (scripts: any, pos: string) => {
  if (!scripts) return null;
  
  switch (pos) {
    case 'header':
      return {
        meta: scripts.header_label_meta,
        css: scripts.header_label_css,
        scripts: scripts.header_label_scripts
      };
    case 'body-top':
      return {
        css: scripts.body_label_top_css,
        scripts: scripts.body_label_top_css_scripts
      };
    case 'body-bottom':
      return {
        css: scripts.body_label_bottom_css,
        scripts: scripts.body_label_bottom_scripts
      };
    default:
      return null;
  }
};

// 获取当前位置的脚本
const currentScripts = dynamicScripts ? getScriptsByPosition(dynamicScripts, position) : null;

// 🚀 脚本内容预处理函数
const preprocessScriptContent = (scriptContent: string) => {
  if (!scriptContent) return '';
  
  let processed = scriptContent;
  
  // 移除所有 HTML 标签
  processed = processed.replace(/<script[^>]*>/gi, '');
  processed = processed.replace(/<\/script>/gi, '');
  processed = processed.replace(/<[^>]*>/g, '');
  
  // 移除 HTML 实体
  processed = processed.replace(/&lt;/g, '<');
  processed = processed.replace(/&gt;/g, '>');
  processed = processed.replace(/&amp;/g, '&');
  processed = processed.replace(/&quot;/g, '"');
  processed = processed.replace(/&#39;/g, "'");
  processed = processed.replace(/&nbsp;/g, ' ');
  
  // 清理多余的空白字符
  processed = processed.trim();
  
  return processed;
};

// 预处理脚本内容
const processedScripts = currentScripts ? {
  ...currentScripts,
  scripts: currentScripts.scripts ? preprocessScriptContent(currentScripts.scripts) : null
} : null;


---

<!-- 🎯 动态脚本加载器 - 位置: {position} -->
{currentScripts && (
  <>
    <!-- 📝 Meta 标签 (仅 header 位置) -->
    {position === 'header' && currentScripts.meta && (
      <Fragment set:html={currentScripts.meta} />
    )}

    <!-- 🎨 CSS 样式 -->
    {currentScripts.css && (
      <Fragment set:html={currentScripts.css} />
    )}

    <!-- 📜 JavaScript 脚本 - 使用 Astro 安全脚本处理 -->
    {processedScripts?.scripts && (
      <script 
        is:inline
        type={optimization.usePartytown ? "text/partytown" : "text/javascript"}
        define:vars={{ 
          scriptContent: processedScripts.scripts,
          position,
          useAsync: optimization.useAsync,
          useLazyLoad: optimization.useLazyLoad
        }}
      >
        // 安全执行脚本内容 - 使用 Astro 优化
        (function() {
          try {
            // 脚本内容已经在服务端预处理过，直接执行
            if (scriptContent && scriptContent.trim()) {
              // 使用 Function 构造函数更安全地执行
              const scriptFunction = new Function(scriptContent);
              scriptFunction();
            }
          } catch (error) {
            console.warn('脚本执行失败:', error);
            // 在开发环境显示详细错误
            if (typeof window !== 'undefined' && window.location.hostname === 'localhost') {
              console.error('脚本内容:', scriptContent);
            }
          }
        })();
      </script>
    )}
  </>
)}

<!-- 开发环境错误提示 -->
{isDev && error && (
  <script define:vars={{ error, position }}>
    console.warn(`🎯 动态脚本加载器 [${position}] 警告:`, error);
  </script>
)}
