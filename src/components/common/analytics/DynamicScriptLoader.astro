---
// ç¯å¢ƒæ£€æµ‹
const isProd = import.meta.env.PROD;
const isDev = import.meta.env.DEV;
// ä¼˜å…ˆè¯»æœåŠ¡ç«¯ç¯å¢ƒå˜é‡ï¼Œå…¶æ¬¡è¯»å…¬å¼€å‰ç¼€ï¼ˆç”¨äºæµè§ˆå™¨ç«¯å…œåº•ï¼‰
const STRAPI_STATIC_URL = (typeof process !== 'undefined' ? process.env.STRAPI_STATIC_URL : '') || import.meta.env.STRAPI_STATIC_URL || '';
// ç”Ÿäº§æ„å»ºç¼ºçœç¦ç”¨åŠ¨æ€è„šæœ¬è·å–ï¼›å¦‚éœ€å¼€å¯ï¼Œè®¾ç½® ENABLE_DYNAMIC_SCRIPTS=true æˆ– PUBLIC_ENABLE_DYNAMIC_SCRIPTS=true
const ENABLE_DYNAMIC_SCRIPTS = (
  (typeof process !== 'undefined' ? process.env.ENABLE_DYNAMIC_SCRIPTS : '') === 'true'
  || import.meta.env.PUBLIC_ENABLE_DYNAMIC_SCRIPTS === 'true'
);
const allowDynamicFetch = isDev || ENABLE_DYNAMIC_SCRIPTS;

// ç»„ä»¶å±æ€§
export interface Props {
  position: 'header' | 'body-top' | 'body-bottom';
  pageType?: string;
  route?: string;
  loadCondition?: boolean;
  lang?: string;
}

const {
  position,
  pageType = 'default',
  route = '',
  loadCondition = true,
  lang = 'en'
} = Astro.props;

// ğŸš€ æ™ºèƒ½ä¼˜åŒ–ç­–ç•¥ - åŸºäºä½ç½®å’Œè„šæœ¬ç±»å‹
const getOptimizationStrategy = () => {
  // Body Bottom ä½ç½®ä½¿ç”¨ Partytownï¼Œå…¶ä»–ä½ç½®ä½¿ç”¨æ ‡å‡†è„šæœ¬
  if (position === 'body-bottom') {
    return { 
      usePartytown: true,
      useLazyLoad: true,
      useAsync: true
    };
  }
  return { 
    usePartytown: false,
    useLazyLoad: false,
    useAsync: false
  };
};

const optimization = getOptimizationStrategy();

// Strapi API é…ç½®ï¼ˆç¼ºå°‘åŸºå€æ—¶ç›´æ¥è·³è¿‡åŠ è½½ï¼Œé¿å… undefined/... æŠ¥é”™ï¼‰
const STRAPI_API_URL = STRAPI_STATIC_URL ? `${STRAPI_STATIC_URL}/api/insert-code` : '';

// è·å–åŠ¨æ€è„šæœ¬æ•°æ® - åœ¨æ„å»ºæ—¶æ‰§è¡Œ
let dynamicScripts = null;
let error = null;

// æŒ‰éœ€åŠ è½½æ¡ä»¶æ£€æŸ¥ï¼ˆä»…å¼€å‘æˆ–æ˜¾å¼å¼€å¯æ—¶æ‰ä¼šåœ¨æ„å»ºæœŸè§¦å‘è¿œç¨‹è·å–ï¼‰
const shouldLoadScripts = allowDynamicFetch && loadCondition && STRAPI_API_URL && (
  pageType !== 'none' && 
  route !== 'excluded'
);

if (shouldLoadScripts) {
  try {
    const response = await fetch(STRAPI_API_URL, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        ...(process.env.STRAPI_API_TOKEN ? { 'Authorization': `Bearer ${process.env.STRAPI_API_TOKEN}` } : {})
      },
      // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¼“å­˜ï¼Œå¼€å‘ç¯å¢ƒå®æ—¶è·å–
      cache: isProd ? 'force-cache' : 'no-store'
    });

    if (response.ok) {
      const data = await response.json();
      dynamicScripts = data.data;
    } else {
      error = `API è¯·æ±‚å¤±è´¥: ${response.status}`;
      if (isDev) console.error('åŠ¨æ€è„šæœ¬åŠ è½½å™¨é”™è¯¯:', error);
    }
  } catch (err: any) {
    error = `è·å–åŠ¨æ€è„šæœ¬å¤±è´¥: ${err.message}`;
    if (isDev) console.error('åŠ¨æ€è„šæœ¬åŠ è½½å™¨é”™è¯¯:', error);
  }
}

// æ ¹æ®ä½ç½®è¿‡æ»¤è„šæœ¬å†…å®¹
const getScriptsByPosition = (scripts: any, pos: string) => {
  if (!scripts) return null;
  
  switch (pos) {
    case 'header':
      return {
        meta: scripts.header_label_meta,
        css: scripts.header_label_css,
        scripts: scripts.header_label_scripts
      };
    case 'body-top':
      return {
        css: scripts.body_label_top_css,
        scripts: scripts.body_label_top_css_scripts
      };
    case 'body-bottom':
      return {
        css: scripts.body_label_bottom_css,
        scripts: scripts.body_label_bottom_scripts
      };
    default:
      return null;
  }
};

// è·å–å½“å‰ä½ç½®çš„è„šæœ¬
const currentScripts = dynamicScripts ? getScriptsByPosition(dynamicScripts, position) : null;

// ğŸš€ è„šæœ¬å†…å®¹é¢„å¤„ç†å‡½æ•°
const preprocessScriptContent = (scriptContent: string) => {
  if (!scriptContent) return '';
  
  let processed = scriptContent;
  
  // ç§»é™¤æ‰€æœ‰ HTML æ ‡ç­¾
  processed = processed.replace(/<script[^>]*>/gi, '');
  processed = processed.replace(/<\/script>/gi, '');
  processed = processed.replace(/<[^>]*>/g, '');
  
  // ç§»é™¤ HTML å®ä½“
  processed = processed.replace(/&lt;/g, '<');
  processed = processed.replace(/&gt;/g, '>');
  processed = processed.replace(/&amp;/g, '&');
  processed = processed.replace(/&quot;/g, '"');
  processed = processed.replace(/&#39;/g, "'");
  processed = processed.replace(/&nbsp;/g, ' ');
  
  // æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦
  processed = processed.trim();
  
  return processed;
};

// é¢„å¤„ç†è„šæœ¬å†…å®¹
const processedScripts = currentScripts ? {
  ...currentScripts,
  scripts: currentScripts.scripts ? preprocessScriptContent(currentScripts.scripts) : null
} : null;


---

<!-- ğŸ¯ åŠ¨æ€è„šæœ¬åŠ è½½å™¨ - ä½ç½®: {position} -->
{currentScripts && (
  <>
    <!-- ğŸ“ Meta æ ‡ç­¾ (ä»… header ä½ç½®) -->
    {position === 'header' && currentScripts.meta && (
      <Fragment set:html={currentScripts.meta} />
    )}

    <!-- ğŸ¨ CSS æ ·å¼ -->
    {currentScripts.css && (
      <Fragment set:html={currentScripts.css} />
    )}

    <!-- ğŸ“œ JavaScript è„šæœ¬ - ä½¿ç”¨ Astro å®‰å…¨è„šæœ¬å¤„ç† -->
    {currentScripts?.scripts && (
      <>
        {optimization.usePartytown ? (
          <!-- Partytown è„šæœ¬ - ä½¿ç”¨ define:vars ä¼ é€’è„šæœ¬å†…å®¹ -->
          <script 
            type="text/partytown"
            define:vars={{ 
              scriptContent: processedScripts?.scripts || '',
              position
            }}
          >
            // Partytown ç¯å¢ƒä¸­çš„è„šæœ¬æ‰§è¡Œ
            (function() {
              try {
                if (scriptContent && scriptContent.trim()) {
                  // åœ¨ Partytown ç¯å¢ƒä¸­ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è½¬å‘åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œ
                  eval(scriptContent);
                }
              } catch (error) {
                console.warn('Partytown è„šæœ¬æ‰§è¡Œå¤±è´¥:', error);
              }
            })();
          </script>
        ) : (
          <!-- ä¸»çº¿ç¨‹è„šæœ¬ - ä½¿ç”¨ define:vars å®‰å…¨æ‰§è¡Œ -->
          <script 
            is:inline
            type="text/javascript"
            define:vars={{ 
              scriptContent: processedScripts?.scripts || '',
              position
            }}
          >
            // å®‰å…¨æ‰§è¡Œè„šæœ¬å†…å®¹ - ä¸»çº¿ç¨‹ç¯å¢ƒ
            (function() {
              try {
                if (scriptContent && scriptContent.trim()) {
                  const scriptFunction = new Function(scriptContent);
                  scriptFunction();
                }
              } catch (error) {
                console.warn('è„šæœ¬æ‰§è¡Œå¤±è´¥:', error);
                if (typeof window !== 'undefined' && window.location.hostname === 'localhost') {
                  console.error('è„šæœ¬å†…å®¹:', scriptContent);
                }
              }
            })();
          </script>
        )}
      </>
    )}
  </>
)}

<!-- å¼€å‘ç¯å¢ƒé”™è¯¯æç¤º -->
{isDev && error && (
  <script define:vars={{ error, position }}>
    console.warn(`ğŸ¯ åŠ¨æ€è„šæœ¬åŠ è½½å™¨ [${position}] è­¦å‘Š:`, error);
  </script>
)}
