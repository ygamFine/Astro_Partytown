---
// SSGé™æ€èœå•ç»„ä»¶ - æ„å»ºæ—¶è·å–èœå•æ•°æ®
import { getMenus, getSupportedLanguages } from '../../../lib/strapi.js';
import getDictionary from '../../../i18n/dictionaries.js';
import { themeConfig } from '../../../config/theme.js';
import { buildUrl } from '../../../lib/envConfig.js';

// è·å–å½“å‰é¡µé¢è·¯å¾„ï¼Œç”¨äºæœåŠ¡ç«¯æ¸²æŸ“æ—¶è®¾ç½®é€‰ä¸­çŠ¶æ€
const currentPath = Astro.url.pathname;
// ä¿®å¤æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½¿å…¶èƒ½å¤ŸåŒ¹é… /ja è¿™æ ·çš„è·¯å¾„ï¼ˆä¸éœ€è¦åé¢çš„æ–œæ ï¼‰
let langMatch = currentPath.match(/^\/([a-z]{2}(-[A-Z]{2,4})?)(\/|$)/);
let currentLang = langMatch ? langMatch[1] : 'en'; // é»˜è®¤è‹±æ–‡

// å¦‚æœæ²¡æœ‰ä»è·¯å¾„æ£€æµ‹åˆ°è¯­è¨€ï¼Œå°è¯•ä»å­åŸŸåæ£€æµ‹
if (currentLang === 'en' && currentPath === '/') {
  const hostname = Astro.url.hostname;
  const subdomainToLang = {
    'zh': 'zh-CN',
    'zh-hant': 'zh-Hant',
    'de': 'de',
    'ja': 'ja',
    'fr': 'fr',
    'ar': 'ar',
    'es': 'es',
    'it': 'it',
    'pt': 'pt-pt',
    'nl': 'nl',
    'pl': 'pl',
    'ru': 'ru',
    'th': 'th',
    'id': 'id',
    'vi': 'vi',
    'ms': 'ms',
    'ml': 'ml',
    'my': 'my',
    'hi': 'hi',
    'ko': 'ko',
    'tr': 'tr'
  };
  
  for (const [subdomain, language] of Object.entries(subdomainToLang)) {
    if (hostname.startsWith(`${subdomain}.`)) {
      currentLang = language;
      break;
    }
  }
}

// åŠ è½½ç¿»è¯‘æ•°æ®
const t = getDictionary(currentLang);

// åŠ¨æ€ç”Ÿæˆèœå•é“¾æ¥ - æ ¹æ®ç¯å¢ƒä½¿ç”¨ä¸åŒçš„URLç­–ç•¥
function withLang(path: string) {
  return buildUrl(currentLang, path);
}

// åœ¨æ„å»ºæ—¶è·å–èœå•æ•°æ®
interface MenuItem {
  name: string;
  path: string;
  children?: MenuItem[];
}

let menuItems: MenuItem[] = [];
try {
  menuItems = await getMenus(currentLang);
} catch (error) {
  console.error('è·å–èœå•å¤±è´¥:', error);
  // å¦‚æœæ¥å£å¤±è´¥ï¼Œä¸æ˜¾ç¤ºä»»ä½•èœå•
  menuItems = [];
}



// è·å–æ”¯æŒçš„è¯­è¨€åˆ—è¡¨ï¼ˆä» Strapi APIï¼Œä¸åšç¡¬ç¼–ç å›é€€ï¼‰
let supportedLanguages: Array<{code: string, name: string}> = [];
try {
  supportedLanguages = await getSupportedLanguages();
} catch (error) {
  console.error('è·å–è¯­è¨€åˆ—è¡¨å¤±è´¥:', error);
  supportedLanguages = [];
}
---

<!-- æ¡Œé¢ç«¯èœå• - å®Œæ•´çš„å¯¼èˆªæ å¸ƒå±€ -->
<div class="w-full flex items-center justify-between h-full">
  <!-- å·¦ä¾§ä¸»å¯¼èˆªèœå• -->
  <nav class="flex items-center" aria-label="ä¸»è¦å¯¼èˆª">
    {menuItems.map((item, index) => (
      <div class="relative dropdown-container">
        <div class="flex items-center">
          <a 
            href={withLang(item.path)} 
            class={`menu-item text-white font-semibold text-center py-4 ${
              (currentPath === item.path) || (currentPath === '/' && item.path === '/') ? 'active' : ''
            }`}
            style="font-size: 2rem; width: 15rem; display: flex; align-items: center; justify-content: center;"
            data-path={item.path}
            data-index={index}
          >
            {item.name}
          </a>
          {item.children && (
            <button type="button" class="dropdown-toggle ml-2 flex items-center" aria-haspopup="true" aria-expanded="false" tabindex="0" style="background: none; border: none; padding: 0; cursor: pointer;">
              <svg class="w-4 h-4 dropdown-arrow transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            </button>
          )}
        </div>
        {item.children && (
          <div class="dropdown-menu absolute top-full left-0 bg-white shadow-lg border border-gray-200 rounded-md overflow-hidden z-50 hidden" style="min-width: 32rem;">
            <!-- åªä¿ç•™å­èœå•åˆ—è¡¨ï¼Œä¸æ˜¾ç¤ºProduct Categoriesç­‰å¼¹æ¡†å†…å®¹ -->
            {item.children.map((child, index) => (
              <a 
                href={withLang(child.path)} 
                class={`product-menu-item flex items-center px-6 py-4 text-gray-800 hover:bg-red-50 hover:text-red-600 transition-all duration-200 border-b border-gray-100 last:border-b-0 ${index === 0 ? 'featured-item' : ''}`}
                style="font-size: 1.5rem;"
              >
                <div class="menu-icon w-8 h-8 mr-4 flex items-center justify-center rounded-full bg-gray-100 text-gray-600">
                  <!-- ä¿ç•™åŸæœ‰å›¾æ ‡é€»è¾‘ -->
                  {index === 0 ? (
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a2.5 2.5 0 011.95 2H17a1 1 0 001-1V8a1 1 0 00-1-1h-3z"/>
                    </svg>
                  ) : null}
                </div>
                <div class="flex-1">
                  <div class="font-medium">{child.name}</div>
                </div>
              </a>
            ))}
          </div>
        )}
      </div>
    ))}
  </nav>

  <!-- å³ä¾§åŠŸèƒ½åŒº -->
  <div class="flex items-center space-x-4">
    <!-- æœç´¢æ¡† -->
    <div class="relative" id="header-search-container">
      <input 
        type="text" 
        id="header-search-input"
        placeholder={t.placeholder.search}
        class="round bg-red-500/95 border border-red-400/30 text-white placeholder-white/70 px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-200"
        style="width: 30rem; font-size: 1.4rem;"
        autocomplete="off"
      />
      <button 
        type="submit"
        id="header-search-button"
        class="absolute right-2 top-1/2 transform -translate-y-1/2"
      >
        <svg class="w-5 h-5 text-white/70 hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </button>
      
      <!-- æœç´¢ç»“æœä¸‹æ‹‰æ¡† -->
      <div 
        id="header-search-results" 
        class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto"
        style="width: 30rem;"
      >
        <div id="header-search-results-content" class="p-2">
          <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
      </div>
    </div>

    <!-- è´­ç‰©è½¦å›¾æ ‡å’Œåœ°çƒå›¾æ ‡ - æŒ‰åŸå‹å›¾æ ·å¼ -->
    <div class="flex items-center">
      <!-- è´­ç‰©è½¦å›¾æ ‡ -->
      <button class="text-white hover:text-white/80 transition-colors duration-200 p-2">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m7.5-5v6a2 2 0 01-2 2H9a2 2 0 01-2-2v-6"/>
        </svg>
      </button>

      <!-- å‚ç›´åˆ†éš”çº¿ -->
      <div class="border-l border-white/30 h-8 mx-6"></div>

      <!-- åœ°çƒå›¾æ ‡ -->
      <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/>
        <path d="M2 12h20"/>
        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
      </svg>
    </div>

    <!-- è¯­è¨€é€‰æ‹©å™¨ -->
    {themeConfig.languageSelector.showLanguageSelector && 
     (!themeConfig.languageSelector.hideWhenSingleLanguage || supportedLanguages.length > 1) && (
    <div class="relative flex items-center space-x-2">
      
      <!-- é€‰æ‹©å™¨æ¡† -->
      <button id="language-selector" class="flex items-center space-x-2 bg-transparent border border-white/30 rounded px-3 py-2 text-white hover:bg-white/10 transition-all duration-200" style="font-size: 1.4rem;">
        <span id="current-language-display">
          {supportedLanguages.find(lang => lang.code === currentLang)?.name || currentLang}
        </span>
        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <script define:vars={{ currentLang, supportedLanguages }}>
          console.log('ğŸ”§ StaticMenu è°ƒè¯•ä¿¡æ¯:', { currentLang, supportedLanguages });
        </script>
        <svg class="w-4 h-4 transition-transform duration-200" id="language-arrow" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>

      <!-- ä¸‹æ‹‰èœå• -->
      <div id="language-dropdown" class="absolute top-full right-0 mt-1 bg-white rounded-md shadow-lg border border-gray-200 overflow-hidden z-50 hidden" style="min-width: 16rem; max-height: 60vh; overflow-y: auto;">
        {supportedLanguages.map(lang => (
          <a href="#" class={`flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 transition-colors duration-200 language-option ${lang.code === currentLang ? 'bg-blue-50 border-l-4 border-blue-500' : ''}`} data-lang={lang.code} data-name={lang.name}>
            <span class="text-2xl">ğŸŒ</span>
            <span class="text-gray-800 font-medium">{lang.name}</span>
            {lang.code === currentLang && (
              <svg class="w-4 h-4 text-blue-500 ml-auto" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            )}
          </a>
        ))}
      </div>
    </div>
    )}
  </div>
</div>

<!-- ç§»åŠ¨ç«¯èœå•å†…å®¹ -->
<div id="mobile-menu-items" class="hidden">
  {menuItems.map((item, index) => (
    <a 
      href={withLang(item.path)} 
      class={`block text-white hover:text-red-400 rounded-lg px-4 py-3 font-semibold focus-visible-ring touch-manipulation mobile-menu-item border-b border-gray-600 last:border-b-0 ${index === 0 ? 'mobile-active' : ''}`}
      data-path={item.path}
      data-index={index}
    >
      {item.name}
    </a>
  ))}
</div>

<script>
  // ç«‹å³æ‰§è¡Œï¼Œä¸ç­‰å¾…DOMå®Œå…¨åŠ è½½
  (function initMenu() {
    // å¦‚æœDOMè¿˜æœªå‡†å¤‡å¥½ï¼Œåˆ™ç­‰å¾…
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMenuComponents);
    } else {
      // DOMå·²å‡†å¤‡å¥½ï¼Œç«‹å³æ‰§è¡Œ
      initMenuComponents();
    }
  })();

  function initMenuComponents() {
    // ç§»åŠ¨ç«¯èœå•åˆå§‹åŒ–
    const mobileMenuItems = document.getElementById('mobile-menu-items');
    const mobileContainer = document.getElementById('mobile-smart-menu');
    
    if (mobileMenuItems && mobileContainer) {
      // å¤åˆ¶èœå•é¡¹åˆ°ç§»åŠ¨ç«¯å®¹å™¨
      mobileContainer.innerHTML = mobileMenuItems.innerHTML;
      
      // ä¸ºç§»åŠ¨ç«¯èœå•é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
      mobileContainer.querySelectorAll('.mobile-menu-item').forEach(link => {
        link.addEventListener('click', () => {
          // ç§»é™¤æ‰€æœ‰ç§»åŠ¨ç«¯èœå•é¡¹çš„é€‰ä¸­çŠ¶æ€
          mobileContainer.querySelectorAll('.mobile-menu-item').forEach(item => {
            item.classList.remove('mobile-active');
          });
          
          // ä¸ºå½“å‰ç‚¹å‡»çš„èœå•é¡¹æ·»åŠ é€‰ä¸­çŠ¶æ€
          link.classList.add('mobile-active');
          
          // å…³é—­ç§»åŠ¨ç«¯èœå•
          const mobileMenu = document.getElementById('mobile-menu');
          const menuButton = document.getElementById('mobile-menu-button');
          const openIcon = document.getElementById('menu-open-icon');
          const closeIcon = document.getElementById('menu-close-icon');
          
          if (mobileMenu) {
            mobileMenu.classList.add('hidden');
            if (menuButton) menuButton.setAttribute('aria-expanded', 'false');
            if (openIcon) openIcon.classList.remove('hidden');
            if (closeIcon) closeIcon.classList.add('hidden');
          }
        });
      });
    }

    // è¯­è¨€é€‰æ‹©å™¨åŠŸèƒ½
    const languageSelector = document.getElementById('language-selector') as HTMLElement | null;
    const languageDropdown = document.getElementById('language-dropdown') as HTMLElement | null;
    const languageArrow = document.getElementById('language-arrow') as HTMLElement | null;
    
    if (languageSelector && languageDropdown && languageArrow) {
      // åˆ‡æ¢ä¸‹æ‹‰èœå•
      languageSelector.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isHidden = languageDropdown.classList.contains('hidden');
        
        if (isHidden) {
          languageDropdown.classList.remove('hidden');
          (languageArrow as HTMLElement).style.transform = 'rotate(180deg)';
        } else {
          languageDropdown.classList.add('hidden');
          (languageArrow as HTMLElement).style.transform = 'rotate(0deg)';
        }
      });

      // è¯­è¨€é€‰é¡¹ç‚¹å‡»äº‹ä»¶
      const languageOptions = document.querySelectorAll('.language-option') as NodeListOf<HTMLElement>;
      languageOptions.forEach(option => {
        option.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const selectedLang = option.getAttribute('data-lang');
          const selectedName = option.getAttribute('data-name');
          
          console.log('è¯­è¨€é€‰æ‹©å™¨ç‚¹å‡»:', { selectedLang, selectedName });
          
          if (selectedLang && selectedName) {
            // è·å–å½“å‰é¡µé¢è·¯å¾„
            const currentPath = window.location.pathname;
            console.log('å½“å‰è·¯å¾„:', currentPath);
            
            // æ ¹æ®ç¯å¢ƒæ„å»ºè¯­è¨€åˆ‡æ¢URL
            const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            console.log('æ˜¯å¦å¼€å‘ç¯å¢ƒ:', isDev);
            
            // æ›¿æ¢è¯­è¨€å‰ç¼€
            const pathWithoutLang: string = currentPath.replace(/^\/([a-z]{2}(-[A-Z]{2,4})?)(\/|$)/, '/');
            
            if (isDev) {
              // æœ¬åœ°å¼€å‘ï¼šæ€»æ˜¯è·³è½¬åˆ°é¦–é¡µ
              const newPath = `/${selectedLang}/`;
              console.log('å¼€å‘ç¯å¢ƒè·³è½¬è·¯å¾„:', newPath);
              // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€
              window.open(newPath, '_blank');
            } else {
              // ç”Ÿäº§ç¯å¢ƒï¼šæ„å»ºå­åŸŸåURLï¼Œæ€»æ˜¯è·³è½¬åˆ°é¦–é¡µ
              const subdomain = selectedLang === 'zh-CN' ? 'zh' : selectedLang === 'zh-Hant' ? 'zh-hant' : selectedLang;
              const currentDomain = window.location.hostname;
              const baseDomain = currentDomain.split('.').slice(-2).join('.'); // è·å–ä¸»åŸŸå
              const newUrl = `https://${subdomain}.${baseDomain}`;
              console.log('ç”Ÿäº§ç¯å¢ƒè·³è½¬URL:', newUrl);
              // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€
              window.open(newUrl, '_blank');
            }
          }
          
          // å…³é—­ä¸‹æ‹‰èœå•
          languageDropdown.classList.add('hidden');
          (languageArrow as HTMLElement).style.transform = 'rotate(0deg)';
        });
      });

      // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
      document.addEventListener('click', (e) => {
        const target = e.target as Node;
        if (target && !languageSelector.contains(target as Node) && !languageDropdown.contains(target as Node)) {
          languageDropdown.classList.add('hidden');
          (languageArrow as HTMLElement).style.transform = 'rotate(0deg)';
        }
      });
      
      // åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨æ˜¾ç¤ºå½“å‰è¯­è¨€
      function initLanguageSelector() {
        // é¦–å…ˆå°è¯•ä»URLè·¯å¾„è·å–è¯­è¨€
        const currentPath = window.location.pathname;
        let langMatch = currentPath.match(/^\/([a-z]{2}(-[A-Z]{2,4})?)(\/|$)/);
        let currentLang = langMatch ? langMatch[1] : 'en';
        
        // å¦‚æœæ²¡æœ‰ä»è·¯å¾„æ£€æµ‹åˆ°è¯­è¨€ï¼Œæˆ–è€…è·¯å¾„ä¸æ˜¯æ ¹ç›®å½•ï¼Œéƒ½å°è¯•ä»å­åŸŸåæ£€æµ‹
        if (currentLang === 'en') {
          const hostname = window.location.hostname;
          const subdomainToLang = {
            'zh': 'zh-CN',
            'zh-hant': 'zh-Hant',
            'de': 'de',
            'ja': 'ja',
            'fr': 'fr',
            'ar': 'ar',
            'es': 'es',
            'it': 'it',
            'pt': 'pt-pt',
            'nl': 'nl',
            'pl': 'pl',
            'ru': 'ru',
            'th': 'th',
            'id': 'id',
            'vi': 'vi',
            'ms': 'ms',
            'ml': 'ml',
            'my': 'my',
            'hi': 'hi',
            'ko': 'ko',
            'tr': 'tr'
          };
          
          for (const [subdomain, language] of Object.entries(subdomainToLang)) {
            if (hostname.startsWith(`${subdomain}.`)) {
              currentLang = language;
              break;
            }
          }
        }
        
        console.log('ğŸ”§ å®¢æˆ·ç«¯è¯­è¨€æ£€æµ‹ç»“æœ:', { currentPath, currentLang, hostname: window.location.hostname });
        
        // æŸ¥æ‰¾å¯¹åº”çš„è¯­è¨€é€‰é¡¹
        const currentLangOption = document.querySelector(`[data-lang="${currentLang}"]`);
        
        if (!languageSelector) {
          console.log('âŒ è¯­è¨€é€‰æ‹©å™¨å…ƒç´ æœªæ‰¾åˆ°');
          return;
        }
        
        const selectorText = document.getElementById('current-language-display');
        
        if (currentLangOption && selectorText) {
          const selectedName = currentLangOption.getAttribute('data-name');
          if (selectedName) {
            selectorText.textContent = selectedName;
            console.log('âœ… è®¾ç½®è¯­è¨€é€‰æ‹©å™¨æ˜¾ç¤º:', selectedName);
          } else {
            selectorText.textContent = currentLang;
            console.log('âš ï¸ ä½¿ç”¨è¯­è¨€ä»£ç æ˜¾ç¤º:', currentLang);
          }
        } else if (selectorText) {
          // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„è¯­è¨€é€‰é¡¹ï¼Œæ˜¾ç¤ºè¯­è¨€ä»£ç 
          selectorText.textContent = currentLang;
          console.log('âš ï¸ ä½¿ç”¨è¯­è¨€ä»£ç æ˜¾ç¤º:', currentLang);
        }
        
        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.language-option').forEach(option => {
          option.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
        });
        
        if (currentLangOption) {
          currentLangOption.classList.add('bg-blue-50', 'border-l-4', 'border-blue-500');
          console.log('âœ… æ›´æ–°è¯­è¨€é€‰é¡¹é€‰ä¸­çŠ¶æ€:', currentLang);
        } else {
          console.log('âŒ æœªæ‰¾åˆ°å¯¹åº”çš„è¯­è¨€é€‰é¡¹:', currentLang);
        }
      }
      
      // åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨
      initLanguageSelector();
      
      // ç¡®ä¿åœ¨é¡µé¢å®Œå…¨åŠ è½½åå†æ¬¡åˆå§‹åŒ–
      if (document.readyState === 'complete') {
        setTimeout(initLanguageSelector, 100);
      } else {
        window.addEventListener('load', () => {
          setTimeout(initLanguageSelector, 100);
        });
      }
    }

    // ä¸‹æ‹‰èœå•åŠŸèƒ½
    function initDropdownMenus() {
      // åªä¸º.dropdown-toggleæŒ‰é’®ç»‘å®šå±•å¼€äº‹ä»¶
      document.querySelectorAll('.dropdown-toggle').forEach(toggleBtn => {
        const dropdownContainer = toggleBtn.closest('.dropdown-container');
        if (!dropdownContainer) return;
        const dropdownMenu = dropdownContainer.querySelector('.dropdown-menu');
        const dropdownArrow = toggleBtn.querySelector('.dropdown-arrow');
        toggleBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (!dropdownMenu) return;
          const isHidden = dropdownMenu.classList.contains('hidden');
          requestAnimationFrame(() => {
            dropdownMenu.classList.toggle('hidden');
            if (dropdownArrow) {
              dropdownArrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
            }
          });
        });
      });

      // ç‚¹å‡»é¡µé¢å…¶å®ƒåœ°æ–¹å…³é—­æ‰€æœ‰ä¸‹æ‹‰
      document.addEventListener('click', (e) => {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
          menu.classList.add('hidden');
        });
        document.querySelectorAll('.dropdown-arrow').forEach(arrow => {
          arrow.style.transform = 'rotate(0deg)';
        });
      });
    }
    
    // æ›´æ–°èœå•é€‰ä¸­çŠ¶æ€
    function updateActiveMenuItem(clickedItem: HTMLElement) {
      const menuItems = document.querySelectorAll('.menu-item');
      
      // ç§»é™¤æ‰€æœ‰èœå•é¡¹çš„activeçŠ¶æ€
      menuItems.forEach(menuItem => {
        menuItem.classList.remove('active');
      });
      
      // ä¸ºå½“å‰ç‚¹å‡»çš„èœå•é¡¹æ·»åŠ activeçŠ¶æ€
      clickedItem.classList.add('active');
      
      // å‚¨å­˜é€‰ä¸­çŠ¶æ€åˆ°sessionStorageï¼Œç”¨äºé¡µé¢é—´ä¿æŒçŠ¶æ€
      const href = clickedItem.getAttribute('href');
      if (href) {
        sessionStorage.setItem('activeMenuItem', href);
      }
    }
    
    // æ¡Œé¢ç«¯èœå•é¡¹ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆæ— ä¸‹æ‹‰èœå•çš„é¡¹ç›®ï¼‰
    function initMenuSelection() {
      const menuItems = document.querySelectorAll('.menu-item:not(.has-dropdown)');
      
      menuItems.forEach((item) => {
        item.addEventListener('click', (e) => {
          updateActiveMenuItem(item as HTMLElement);
          // å…è®¸æ­£å¸¸å¯¼èˆª
        });
      });
    }
    
    // è®¾ç½®å½“å‰é¡µé¢èœå•é¡¹ä¸ºé€‰ä¸­çŠ¶æ€
    function setActiveMenuItem() {
      const currentPath = window.location.pathname;
      const menuItems = document.querySelectorAll('.menu-item');
      
      // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æœåŠ¡ç«¯æ¸²æŸ“çš„é€‰ä¸­çŠ¶æ€
      const hasActiveItem = Array.from(menuItems).some(item => item.classList.contains('active'));
      
      if (!hasActiveItem) {
        // å¦‚æœæ²¡æœ‰é¢„è®¾çš„é€‰ä¸­çŠ¶æ€ï¼Œè¿›è¡Œå®¢æˆ·ç«¯è®¾ç½®
        let foundMatch = false;
        
        menuItems.forEach(item => {
          const href = item.getAttribute('href') || item.getAttribute('data-path');
          if (href === currentPath || (currentPath === '/' && href === '/')) {
            item.classList.add('active');
            foundMatch = true;
          }
        });
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…é¡¹ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
        if (!foundMatch && menuItems.length > 0) {
          menuItems[0].classList.add('active');
        }
      }
      
      // ç¡®ä¿åªæœ‰ä¸€ä¸ªèœå•é¡¹è¢«é€‰ä¸­
      const activeItems = document.querySelectorAll('.menu-item.active');
      if (activeItems.length > 1) {
        // å¦‚æœæœ‰å¤šä¸ªé€‰ä¸­é¡¹ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ª
        for (let i = 1; i < activeItems.length; i++) {
          activeItems[i].classList.remove('active');
        }
      }
    }
    
    // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
    initDropdownMenus();
    initMenuSelection();
    setActiveMenuItem();
    
    // æ ‡è®°èœå•å·²åŠ è½½å®Œæˆ
    const nav = document.querySelector('nav');
    if (nav) {
      nav.classList.add('menu-loaded');
    }
    
    // åˆå§‹åŒ–å¤´éƒ¨æœç´¢åŠŸèƒ½
    initHeaderSearch();
  }
  
  // å¤´éƒ¨æœç´¢åŠŸèƒ½
  function initHeaderSearch() {
    const searchInput = document.getElementById('header-search-input') as HTMLInputElement;
    const searchButton = document.getElementById('header-search-button');
    const searchResults = document.getElementById('header-search-results');
    const searchResultsContent = document.getElementById('header-search-results-content');
    
    if (!searchInput || !searchButton || !searchResults || !searchResultsContent) {
      return;
    }
    
    let debounceTimer: NodeJS.Timeout | null = null;
    
    // è·å–å½“å‰è¯­è¨€
    const currentLang = window.location.pathname.split('/')[1] || 'en';
    
    // æ‰§è¡Œæœç´¢
    async function performSearch(query: string) {
      if (!query || query.trim() === '') {
        hideResults();
        return;
      }
      
      try {
        const { performSearch: searchFunction } = await import('/src/lib/clientSearch.js');
        const results = await searchFunction(query, currentLang);
        displayResults(results, query);
      } catch (error) {
        console.error('Search error:', error);
        hideResults();
      }
    }
    
    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function displayResults(results: any[], query: string) {
      if (!searchResultsContent) return;
      
      if (results.length === 0) {
        searchResultsContent.innerHTML = `
          <div class="p-4 text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.47-.881-6.08-2.33" />
            </svg>
            <p>No results found for "${query}"</p>
          </div>
        `;
      } else {
        searchResultsContent.innerHTML = results.slice(0, 5).map(item => `
          <a href="${item.url}" class="block p-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0">
            <div class="flex items-start space-x-3">
              <div class="flex-shrink-0">
                <img src="${item.image}" alt="${item.title || ''}" class="w-12 h-12 object-cover rounded" onerror="this.style.display='none'">
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="text-sm font-medium text-gray-900 truncate">${highlightText(item.title, query)}</h4>
                <p class="text-xs text-gray-500 mt-1 line-clamp-2">${highlightText(item.excerpt, query)}</p>
                <div class="flex items-center mt-2 space-x-2">
                  <span class="inline-block text-xs px-2 py-1 rounded ${getCategoryColor(item.type)}">${getCategoryLabel(item.type)}</span>
                </div>
              </div>
            </div>
          </a>
        `).join('');
      }
      
      showResults();
    }
    
    // é«˜äº®æ–‡æœ¬
    function highlightText(text: string, query: string) {
      if (!query || !text) return text;
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(regex, '<mark class="bg-yellow-200 px-1 rounded">$1</mark>');
    }
    
    // è·å–åˆ†ç±»é¢œè‰²
    function getCategoryColor(type: string) {
      // ä½¿ç”¨é»˜è®¤é¢œè‰²ï¼Œé¿å…ç¡¬ç¼–ç 
      return 'bg-gray-100 text-gray-600';
    }
    
    // è·å–åˆ†ç±»æ ‡ç­¾
    function getCategoryLabel(type: string) {
      // ä½¿ç”¨é»˜è®¤æ ‡ç­¾ï¼Œé¿å…ç¡¬ç¼–ç 
      return type || 'å…¶ä»–';
    }
    
    function showResults() {
      if (searchResults) {
        searchResults.classList.remove('hidden');
      }
    }
    
    function hideResults() {
      if (searchResults) {
        searchResults.classList.add('hidden');
      }
    }
    
    // ç»‘å®šäº‹ä»¶
    searchInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimer!);
      debounceTimer = setTimeout(() => {
        performSearch((e.target as HTMLInputElement).value.trim());
      }, 300);
    });
    
    searchButton.addEventListener('click', (e) => {
      e.preventDefault();
      const query = searchInput.value.trim();
      if (query) {
        window.location.href = `/${currentLang}/search?q=${encodeURIComponent(query)}`;
      }
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­æœç´¢ç»“æœ
    document.addEventListener('click', (e) => {
      const container = document.getElementById('header-search-container');
      if (container && !container.contains(e.target as Node)) {
        hideResults();
      }
    });
    
    // é”®ç›˜å¯¼èˆª
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (query) {
          window.location.href = `/${currentLang}/search?q=${encodeURIComponent(query)}`;
        }
      } else if (e.key === 'Escape') {
        hideResults();
        searchInput.blur();
      }
    });
  }
</script>

<style>
  .menu-item {
    position: relative;
    overflow: hidden;
    height: 6rem;
    min-width: 15rem;
    transition: background-color 0.15s ease;
  }
  
  /* åŸºç¡€èœå•é¡¹æ ·å¼ */
  .menu-item {
    background-color: transparent;
    color: white;
  }
  
  /* é¢„è®¾é€‰ä¸­çŠ¶æ€å·²é€šè¿‡æœåŠ¡ç«¯æ¸²æŸ“å¤„ç†ï¼Œç§»é™¤CSSé¢„è®¾ */
  
  /* é€‰ä¸­çŠ¶æ€ - å½“å‰é¡µé¢ */
  .menu-item.active {
    background-color: #b91c1c !important;
    color: white !important;
  }
  
  /* HoverçŠ¶æ€ - ä½†ä¸è¦†ç›–activeçŠ¶æ€ */
  .menu-item:hover:not(.active) {
    background-color: #b91c1c;
    color: white;
  }
  
  /* èœå•åˆå§‹çŠ¶æ€ - é˜²æ­¢é—ªçƒ */
  nav {
    visibility: visible;
    opacity: 1;
  }
  
  /* èœå•åŠ è½½å®ŒæˆçŠ¶æ€ */
  nav.menu-loaded {
    visibility: visible !important;
    opacity: 1 !important;
  }
  
  /* èœå•å®¹å™¨é¢„åŠ è½½ä¼˜åŒ– */
  .dropdown-container {
    will-change: transform;
  }
  
  /* é˜²æ­¢é¡µé¢è·³è½¬æ—¶çš„é—ªçƒ */
  .menu-item {
    will-change: background-color;
  }
  
  /* é¡µé¢åŠ è½½æ—¶çš„å¹³æ»‘è¿‡æ¸¡ */
  @media (prefers-reduced-motion: no-preference) {
    .menu-item {
      transition: background-color 0.15s ease-out;
    }
  }
  
  /* ç§»é™¤åŸæ¥çš„åŠ¨ç”»æ•ˆæœ */
  .menu-item::before {
    display: none;
  }
  
  /* ä¸‹æ‹‰èœå•å®¹å™¨ */
  .dropdown-container {
    position: relative;
  }
  
  /* ä¸‹æ‹‰èœå•æ ·å¼ */
  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1), 0 3px 10px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    z-index: 1000;
    min-width: 32rem;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-15px) scale(0.95);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* ä¸‹æ‹‰èœå•æ˜¾ç¤ºçŠ¶æ€ */
  .dropdown-menu:not(.hidden) {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }
  
  /* ä¸‹æ‹‰èœå•å¤´éƒ¨ */
  .dropdown-header h3 {
    margin: 0;
    font-size: 1.8rem;
  }
  
  .dropdown-header p {
    margin: 0;
    font-size: 1.4rem;
  }
  
  /* äº§å“èœå•é¡¹æ ·å¼ */
  .product-menu-item {
    position: relative;
    transition: all 0.2s ease;
  }
  
  .product-menu-item:hover {
    background: linear-gradient(to right, #fef2f2, #ffffff);
    transform: translateX(8px);
  }
  
  .product-menu-item:hover .menu-icon {
    background-color: #dc2626;
    color: white;
    transform: scale(1.1);
  }
  
  .product-menu-item .menu-icon {
    transition: all 0.2s ease;
  }
  
  /* ç‰¹è‰²èœå•é¡¹ */
  .featured-item {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-left: 4px solid #dc2626;
  }
  
  .featured-item .menu-icon {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
  }
  
  /* ä¸‹æ‹‰èœå•åº•éƒ¨ */
  .dropdown-footer {
    background: linear-gradient(to right, #f9fafb, #f3f4f6);
  }
  
  /* ä¸‹æ‹‰ç®­å¤´åŠ¨ç”» */
  .dropdown-arrow {
    transition: transform 0.2s ease;
  }
  
  /* æœ‰ä¸‹æ‹‰èœå•çš„èœå•é¡¹ */
  .has-dropdown {
    position: relative;
  }
  
  /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
  @media (max-width: 768px) {
    .mobile-menu-item {
      padding: 12px 16px;
      font-size: 16px;
    }
    
    /* ç§»åŠ¨ç«¯é€‰ä¸­çŠ¶æ€ */
    .mobile-menu-item.mobile-active {
      background-color: #b91c1c !important;
      color: white !important;
    }
    
    /* ç§»åŠ¨ç«¯é»˜è®¤ç¬¬ä¸€ä¸ªé€‰ä¸­ */
    .mobile-menu-item[data-index="0"] {
      background-color: #b91c1c;
      color: white;
    }
  }
</style> 