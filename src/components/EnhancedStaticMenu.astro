---
// å¢å¼ºç‰ˆé™æ€èœå•ç»„ä»¶ - SSGæ¸²æŸ“ + å®¢æˆ·ç«¯åŠ¨æ€æ›´æ–°
import { getMenus } from '../lib/strapi.js';

// æ„å»ºæ—¶è·å–èœå•æ•°æ®ä½œä¸ºåˆå§‹æ•°æ®
let initialMenuItems = [];
try {
  initialMenuItems = await getMenus();
  console.log(`âœ… æ„å»ºæ—¶è·å–åˆ° ${initialMenuItems.length} ä¸ªèœå•é¡¹`);
} catch (error) {
  console.warn('âš ï¸ æ„å»ºæ—¶è·å–èœå•å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤èœå•:', error.message);
  // é»˜è®¤èœå•ä½œä¸ºé™çº§æ–¹æ¡ˆ
  initialMenuItems = [
    { name: 'é¦–é¡µ', path: '/' },
    { name: 'äº§å“ä¸­å¿ƒ', path: '/products' },
    { name: 'æ–°é—»ä¸­å¿ƒ', path: '/news' },
    { name: 'å…³äºæˆ‘ä»¬', path: '/about' },
    { name: 'è”ç³»æˆ‘ä»¬', path: '/contact' }
  ];
}

// å°†åˆå§‹æ•°æ®è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²ï¼Œä¾›å®¢æˆ·ç«¯ä½¿ç”¨
const initialMenuData = JSON.stringify(initialMenuItems);
---

<!-- æ¡Œé¢ç«¯èœå•å®¹å™¨ -->
<nav id="desktop-menu" class="hidden md:flex items-center space-x-8" aria-label="ä¸»è¦å¯¼èˆª">
  {initialMenuItems.map((item) => (
    <a 
      href={item.path} 
      class="menu-item text-gray-600 hover:text-red-600 font-semibold focus-visible-ring transition-all duration-200"
    >
      {item.name}
    </a>
  ))}
</nav>

<!-- ç§»åŠ¨ç«¯èœå•å†…å®¹ -->
<div id="mobile-menu-items" class="hidden">
  {initialMenuItems.map((item) => (
    <a 
      href={item.path} 
      class="block text-gray-700 rounded-lg px-4 py-3 font-semibold focus-visible-ring touch-manipulation mobile-menu-item"
    >
      {item.name}
    </a>
  ))}
</div>

<!-- æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨ -->
<div id="menu-update-indicator" class="hidden fixed top-4 right-4 bg-blue-500 text-white px-3 py-1 rounded-full text-sm z-50">
  èœå•æ›´æ–°ä¸­...
</div>

<script define:vars={{initialMenuData}}>
  class EnhancedMenuManager {
    constructor() {
      this.menuData = JSON.parse(initialMenuData);
      this.updateInterval = 30000; // 30ç§’æ£€æŸ¥ä¸€æ¬¡
      this.isUpdating = false;
      this.retryCount = 0;
      this.maxRetries = 3;
      
      this.init();
    }
    
    init() {
      // åˆå§‹åŒ–ç§»åŠ¨ç«¯èœå•
      this.initMobileMenu();
      
      // å¯åŠ¨å®šæ—¶æ›´æ–°
      this.startPeriodicUpdate();
      
      // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ›´æ–°
      this.setupVisibilityListener();
      
      // ç½‘ç»œçŠ¶æ€å˜åŒ–æ—¶æ›´æ–°
      this.setupNetworkListener();
      
      console.log('ğŸš€ å¢å¼ºèœå•ç®¡ç†å™¨å·²å¯åŠ¨');
    }
    
    initMobileMenu() {
      const mobileMenuItems = document.getElementById('mobile-menu-items');
      const mobileContainer = document.getElementById('mobile-smart-menu');
      
      if (mobileMenuItems && mobileContainer) {
        mobileContainer.innerHTML = mobileMenuItems.innerHTML;
        
        // ä¸ºç§»åŠ¨ç«¯èœå•é¡¹æ·»åŠ ç‚¹å‡»å…³é—­äº‹ä»¶
        mobileContainer.querySelectorAll('.mobile-menu-item').forEach(link => {
          link.addEventListener('click', () => {
            this.closeMobileMenu();
          });
        });
      }
    }
    
    closeMobileMenu() {
      const mobileMenu = document.getElementById('mobile-menu');
      const menuButton = document.getElementById('mobile-menu-button');
      const openIcon = document.getElementById('menu-open-icon');
      const closeIcon = document.getElementById('menu-close-icon');
      
      if (mobileMenu) {
        mobileMenu.classList.add('hidden');
        if (menuButton) menuButton.setAttribute('aria-expanded', 'false');
        if (openIcon) openIcon.classList.remove('hidden');
        if (closeIcon) closeIcon.classList.add('hidden');
      }
    }
    
    async updateMenus() {
      if (this.isUpdating) return;
      
      this.isUpdating = true;
      this.showUpdateIndicator();
      
      try {
        console.log('ğŸ”„ æ£€æŸ¥èœå•æ›´æ–°...');
        
        // æ„å»ºAPI URL
        const apiUrl = `${window.location.origin}/api/strapi-proxy?endpoint=menus`;
        
        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const newMenuData = await response.json();
        
        // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰å˜åŒ–
        if (JSON.stringify(newMenuData) !== JSON.stringify(this.menuData)) {
          console.log('ğŸ“ èœå•æ•°æ®å·²æ›´æ–°');
          this.menuData = newMenuData;
          this.renderMenus();
          this.showUpdateSuccess();
        } else {
          console.log('âœ… èœå•æ•°æ®æ— å˜åŒ–');
        }
        
        this.retryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
        
      } catch (error) {
        console.warn('âš ï¸ èœå•æ›´æ–°å¤±è´¥:', error.message);
        this.handleUpdateError();
      } finally {
        this.isUpdating = false;
        this.hideUpdateIndicator();
      }
    }
    
    renderMenus() {
      // æ›´æ–°æ¡Œé¢ç«¯èœå•
      const desktopMenu = document.getElementById('desktop-menu');
      if (desktopMenu) {
        desktopMenu.innerHTML = this.menuData.map(item => 
          `<a href="${item.path}" class="menu-item text-gray-600 hover:text-red-600 font-semibold focus-visible-ring transition-all duration-200">${item.name}</a>`
        ).join('');
      }
      
      // æ›´æ–°ç§»åŠ¨ç«¯èœå•
      const mobileMenuItems = document.getElementById('mobile-menu-items');
      if (mobileMenuItems) {
        mobileMenuItems.innerHTML = this.menuData.map(item => 
          `<a href="${item.path}" class="block text-gray-700 rounded-lg px-4 py-3 font-semibold focus-visible-ring touch-manipulation mobile-menu-item">${item.name}</a>`
        ).join('');
        
        // é‡æ–°åˆå§‹åŒ–ç§»åŠ¨ç«¯èœå•
        this.initMobileMenu();
      }
    }
    
    handleUpdateError() {
      this.retryCount++;
      if (this.retryCount < this.maxRetries) {
        console.log(`ğŸ”„ ${this.retryCount}/${this.maxRetries} æ¬¡é‡è¯•...`);
        setTimeout(() => this.updateMenus(), 5000 * this.retryCount);
      } else {
        console.error('âŒ èœå•æ›´æ–°å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
        this.retryCount = 0;
      }
    }
    
    startPeriodicUpdate() {
      setInterval(() => {
        if (document.visibilityState === 'visible') {
          this.updateMenus();
        }
      }, this.updateInterval);
      
      // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ›´æ–°
      setTimeout(() => this.updateMenus(), 1000);
    }
    
    setupVisibilityListener() {
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          // é¡µé¢å˜ä¸ºå¯è§æ—¶ç«‹å³æ›´æ–°
          setTimeout(() => this.updateMenus(), 500);
        }
      });
    }
    
    setupNetworkListener() {
      if ('navigator' in window && 'onLine' in navigator) {
        window.addEventListener('online', () => {
          console.log('ğŸŒ ç½‘ç»œå·²è¿æ¥ï¼Œæ›´æ–°èœå•');
          this.updateMenus();
        });
      }
    }
    
    showUpdateIndicator() {
      const indicator = document.getElementById('menu-update-indicator');
      if (indicator) {
        indicator.classList.remove('hidden');
      }
    }
    
    hideUpdateIndicator() {
      const indicator = document.getElementById('menu-update-indicator');
      if (indicator) {
        indicator.classList.add('hidden');
      }
    }
    
    showUpdateSuccess() {
      const indicator = document.getElementById('menu-update-indicator');
      if (indicator) {
        indicator.textContent = 'èœå•å·²æ›´æ–° âœ…';
        indicator.classList.remove('bg-blue-500');
        indicator.classList.add('bg-green-500');
        
        setTimeout(() => {
          indicator.textContent = 'èœå•æ›´æ–°ä¸­...';
          indicator.classList.remove('bg-green-500');
          indicator.classList.add('bg-blue-500');
        }, 2000);
      }
    }
  }
  
  // DOMå°±ç»ªååˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      window.enhancedMenuManager = new EnhancedMenuManager();
    });
  } else {
    window.enhancedMenuManager = new EnhancedMenuManager();
  }
</script>

<style>
  .menu-item {
    position: relative;
    overflow: hidden;
  }
  
  .menu-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.1), transparent);
    transition: left 0.5s;
  }
  
  .menu-item:hover::before {
    left: 100%;
  }
  
  /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
  @media (max-width: 768px) {
    .mobile-menu-item {
      padding: 12px 16px;
      font-size: 16px;
    }
  }
  
  /* æ›´æ–°æŒ‡ç¤ºå™¨åŠ¨ç”» */
  #menu-update-indicator {
    animation: slideInRight 0.3s ease-out;
  }
  
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
</style> 