---
import { Image } from 'astro:assets';
import { getFirstImage, generateUrl } from '@utils/tools';
// 定义组件props接口
export interface Props {
  data?: {
    title?: string;
    description?: string;
    url_text?: string;
    products?: Array<{
      image?: {
        url: string;
        name: string;
      };
    
      name?: string;
      title?: string;
      url?: string;
      url_text?: string;
    }>;
  };
  lang: string;
}
// 获取props，提供默认值
const { data = {}, lang } = Astro.props;
const { 
  title = '', 
  description = '', 
  products = [] 
} = data;

const safeProducts = Array.isArray(products) ? products.slice(0, 10) : [];

---

<section class="product-hot-product">
    <div class="container">
        <div class="product-product-main">
            <h2 class="block-title">{title}</h2>
            <p class="block-desc">{description}</p>
            <div class="swiper honor-swiper2">
                <div class="swiper-wrapper">
                    {safeProducts.map((product, index) => {
                        const productName = product.name || product.title || `Product ${index + 1}`;
                        // 直接使用 product.image，因为它已经是一个对象
                        const productImage = product.image;
                        return (
                          <div class="swiper-slide">
                            <div class="product-item">
                                <div class="product-item-img">
                                    <Image 
                                        src={productImage?.url || '/images/placeholder.webp'}
                                        alt={productImage?.name || productName}
                                        width={330}
                                        height={330}
                                        quality={80}
                                        loading="lazy"
                                        decoding="async"
                                        class="thumbnail-image transition-transform duration-300 hover:scale-105" 
                                    />
                               </div>
                              <p class="product-name">{productName}</p>
                              <a href={product.url} class="product-url">{product.url_text}</a>
                            </div>
                          </div>
                        );
                    })}
                </div>
                <div class="swiper-bottom-box">
                    <!-- 导航按钮 -->
                    <div class="swiper-btn-prev swiper-btns">
                        <i class="iconfont icon-arrowleft"></i>
                    </div>
                    <!-- 分页器 -->
                    <div class="swiper-pagination"></div>
                    <!-- 导航按钮 -->
                    <div class="swiper-btn-next swiper-btns">
                        <i class="iconfont icon-arrowright"></i>
                    </div>
                </div>
                 
               
                
               
            </div>
        </div>
    </div>

</section>

<style>
    .product-hot-product {
       padding-bottom: 8rem; 
    }
    .block-title{
        font-family: Antonio-Bold;
        font-size: 6rem;
        color: #18181F;
        text-align: center;
    }
    .block-desc{
        font-weight: 400;
        font-size: 1.6rem;
        color: #18181F;
        line-height: 2.4rem;
        text-align: center;
        width: 50%;
        margin: 0 auto;
    }
    .product-hot-product .container{
        width: 100%;
        padding: 0 6rem;
    }
    .product-hot-product .product-item{
        cursor: pointer;
        text-align: center;
    }
    .product-hot-product .product-item .product-item-img{
        overflow: hidden;
    }
    .product-hot-product .product-item img{
        width: 100%;
        height: auto;
        transition: all 1s ease;
    }
    .product-hot-product .product-item:hover img{
        transform: scale(1.1);
    }
    .product-hot-product .product-item .product-name{
        font-weight: 400;
        font-size: 1.8rem;
        color: #18181F;
        line-height: 2.4rem;
        height: 4.8rem;
        padding: 0 1rem;
        margin-top: 1.6rem;
        text-align: center;
    }
    .product-hot-product .product-item .product-url{
        display: inline-block;
        width: auto;
        padding: 0 0.5rem;
        height: 3rem;
        line-height: 3rem;
        position: relative;
        z-index: 3;
        overflow: hidden;
        font-family: Poppins-Medium;
        font-weight: 500;
        font-size: 2rem;
        color: #18181F;
        transition: all .3s linear;
    }
    .product-hot-product .product-item .product-url:hover{
        color: #FEFEFE;
    }
    .product-hot-product .product-item .product-url::before{
        content: '';
        display: inline-block;
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -1;
        width: 100%;
        height: 3px;
        background: #E81A1A;
        transition: all .3s linear;
    }
    .product-hot-product .product-item .product-url:hover:before{
        height: 100%;
    }
    
    /* Swiper 样式 */
    .honor-swiper2 {
       margin-top: 6rem;
    }
    
    .honor-swiper2 .swiper-slide {
        height: auto;
        width: 382.6px;
        margin-right: 37px;
        word-break: normal;
    }
    .honor-swiper2 .swiper-bottom-box{
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        padding-bottom: 5px;
        margin-top: 7rem;
    }
    
    .honor-swiper2 .swiper-btns{
        position: relative;
        top:-5px;
    }
    .honor-swiper2 .swiper-btns i {
        color: #dc2626;
        border-radius: 50%;
        width: 16px;
        height: 14px;
        transition: all 0.3s ease;
        width: 2rem;
        height: 2rem;
        font-size: 2rem;
    }
    
    .honor-swiper2 .swiper-btns i:hover {
        background: #dc2626;
        color: white;
        transform: scale(1.1);
    }
    
    .honor-swiper2 .swiper-button-next:after,
    .honor-swiper2 .swiper-button-prev:after {
        content: '';
        font-size: 18px;
        font-weight: bold;
        display: inline-block;
    }
    
    .honor-swiper2 .swiper-pagination {
        position: relative;
        width: auto !important;
    }
    
    /* 分页点样式 - 使用 CSS 变量和最高优先级 */
    .product-hot-product .honor-swiper2 .swiper-pagination {
        --swiper-pagination-bullet-size: 1.2rem;
        --swiper-pagination-bullet-horizontal-gap: 0.5rem;
    }
    .product-hot-product .honor-swiper2 .swiper-pagination::after{
        content: '';
        width: 113%;
        height: 2px;
        background: #DDDDDD;
        position: absolute;
        bottom:-5px;
        left: -1rem;
    }
    
    .product-hot-product .honor-swiper2 .swiper-pagination .swiper-pagination-bullet,
    .product-hot-product .honor-swiper2 .swiper-pagination-bullet {
        width: 1.2rem !important;
        height: 1.2rem !important;
        background: #18181F !important;
        border-radius: 50% !important;
        opacity: 1 !important;
        transition: all 0.3s ease !important;
        margin: 0 0.5rem !important;
        border: none !important;
        outline: none !important;
        box-sizing: border-box !important;
        display: inline-block !important;
    }
    
    .product-hot-product .honor-swiper2 .swiper-pagination .swiper-pagination-bullet.swiper-pagination-bullet-active,
    .product-hot-product .honor-swiper2 .swiper-pagination-bullet-active {
        opacity: 1 !important;
        background: #E81A1A !important;
    }
   
    
    /* 全局覆盖 - 作为备用 */
    .swiper-pagination-bullet {
        width: 1.2rem !important;
        height: 1.2rem !important;
        background: #18181F !important;
        border-radius: 50% !important;
        opacity: 1 !important;
        transition: all 0.3s ease !important;
        margin: 0 0.5rem !important;
        border: none !important;
        outline: none !important;
        display: inline-block !important;
    }
    
    .swiper-pagination-bullet-active {
        opacity: 1 !important;
        background: #E81A1A !important;
        transform: scale(1.2) !important;
    }
 
    
    /* 响应式调整 */
    @media (max-width: 768px) {
      section.product-hot-product {
        padding:0 1rem;
        .container{
          padding:0 1rem !important;
        }
          .block-title{
            font-size: 3rem;
            line-height: 4rem;
          }
          .block-desc{
            width: 96%;
          }
          .honor-swiper2{
            margin-top: 4rem;
            .swiper-slide{
                width: 189px;
                margin-right: 15px;
            }
          }
        }
    }
    
</style>

<!-- 使用 Intersection Observer 实现懒加载 -->
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        // 检查是否存在轮播容器
        const swiperContainer = document.querySelector('.honor-swiper2');
        if (!swiperContainer) {
            console.warn('轮播容器 .honor-swiper2 未找到');
            return;
        }

        // 创建 Intersection Observer
        const observer = new IntersectionObserver(async (entries) => {
            for (const entry of entries) {
                if (entry.isIntersecting) {
                    // 元素进入视口时初始化 Swiper
                    try {
                        // 使用共享的 Swiper 加载器
                        const Swiper = (await import('swiper/bundle')).default;

                        // 初始化 Swiper
                        const swiper = new Swiper('.honor-swiper2', {
                // 基本配置
                slidesPerView: 2,
                spaceBetween: 15,
                loop: true,
                autoplay: {
                    delay: 5000,
                    disableOnInteraction: false,
                },

                // 响应式断点
                breakpoints: {
                    640: {
                        slidesPerView: 2,
                        spaceBetween: 20,
                    },
                    768: {
                        slidesPerView: 3,
                        spaceBetween: 30,
                    },
                    1024: {
                        slidesPerView: 5,
                        spaceBetween: 37,
                    },
                },

                // 分页器
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                    dynamicBullets: false,
                    renderBullet: function (index: number, className: string) {
                        return '<span class="' + className + '" style="width: 1.2rem; height: 1.2rem; background: #18181F; opacity: 1; border-radius: 50%; margin: 0 0.5rem; transition: all 0.3s ease;"></span>';
                    },
                },

                // 导航按钮
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },

                // 效果
                effect: 'slide',
                speed: 600,

                // 鼠标悬停暂停自动播放
                on: {
                    init: function(swiper: any) {
                        swiper.el.addEventListener('mouseenter', () => {
                            if (swiper.autoplay) {
                                swiper.autoplay.stop();
                            }
                        });
                        swiper.el.addEventListener('mouseleave', () => {
                            if (swiper.autoplay) {
                                swiper.autoplay.start();
                            }
                        });
                    }
                }
            });


            // 强制应用分页点样式
            const applyBulletStyles = () => {
                const bullets = document.querySelectorAll('.honor-swiper2 .swiper-pagination-bullet');
                bullets.forEach(bullet => {
                    const bulletElement = bullet as HTMLElement;
                    bulletElement.style.setProperty('width', '1.2rem', 'important');
                    bulletElement.style.setProperty('height', '1.2rem', 'important');
                    bulletElement.style.setProperty('background', '#18181F', 'important');
                    bulletElement.style.setProperty('opacity', '1', 'important');
                    bulletElement.style.setProperty('border-radius', '50%', 'important');
                    bulletElement.style.setProperty('margin', '0 1rem', 'important');
                    bulletElement.style.setProperty('transition', 'all 0.3s ease', 'important');
                    bulletElement.style.setProperty('border', 'none', 'important');
                    bulletElement.style.setProperty('outline', 'none', 'important');
                });

                // 设置激活状态
                const activeBullet = document.querySelector('.honor-swiper2 .swiper-pagination-bullet-active') as HTMLElement;
                if (activeBullet) {

                    activeBullet.style.setProperty('background', '#E81A1A', 'important');
                }
            };

            // 立即应用样式
            applyBulletStyles();

            // 延迟再次应用，确保覆盖
            setTimeout(applyBulletStyles, 100);
            setTimeout(applyBulletStyles, 500);

            // 监听分页点变化
            swiper.on('slideChange', function () {
                setTimeout(applyBulletStyles, 50);
            });

                    } catch (error) {
                        console.error('Swiper 加载失败:', error);
                    }
                    
                    // 停止观察，避免重复初始化
                    observer.unobserve(entry.target);
                }
            }
        }, {
            // 当元素 10% 可见时触发
            threshold: 0.1,
            // 提前 50px 开始加载
            rootMargin: '50px'
        });

        // 开始观察轮播容器
        observer.observe(swiperContainer);
    });
</script>
