---
import Header from "../components/Header.astro";
import FooterSection from "../components/FooterSection.astro";

export interface Props {
  title: string;
  description?: string;
}

const {
  title,
  description = "山东永安建设机械集团有限公司 - 专业工程机械制造商",
} = Astro.props;
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO优化 -->
    <meta
      name="keywords"
      content="滑移装载机,工程机械,建筑设备,山东永安,YONAN"
    />
    <meta name="author" content="山东永安建设机械集团有限公司" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />

    <!-- 性能优化 -->
    <meta name="theme-color" content="#e60012" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- 🚀 关键图片预加载 -->
    <link
      rel="preload"
      href="/images/mobile-banner-tiny.svg"
      as="image"
      media="(max-width: 768px)"
      fetchpriority="high"
    />

    <!-- 🚀 Partytown配置 - 基础配置，详细配置在 astro.config.mjs -->
    <script is:inline>
      // 基础配置会被astro.config.mjs中的配置扩展
      window.partytown = window.partytown || {};
    </script>

    <!-- DNS预连接优化 -->
    <link rel="preconnect" href="https://www.googletagmanager.com" />
    <link rel="preconnect" href="https://www.google-analytics.com" />

    <!-- 🚀 极致Speed Index优化 - 目标<2.5秒 -->
    <style>
      /* 立即显示关键内容 - 零延迟 */
      .speed-critical {
        opacity: 1 !important;
        visibility: visible !important;
        transform: none !important;
        animation: none !important;
        transition: none !important;
        will-change: auto !important;
      }

      /* 基础重置 */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        line-height: 1.6;
        color: #333;
        background: #fff;
        /* 禁用所有非关键动画 */
        animation-duration: 0s !important;
        animation-delay: 0s !important;
      }

      /* 关键内容样式 */
      .text-4xl {
        font-size: 2.25rem;
        line-height: 2.5rem;
      }
      .font-bold {
        font-weight: 700;
      }
      .text-gray-800 {
        color: #1f2937;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .text-center {
        text-align: center;
      }
      .py-20 {
        padding-top: 5rem;
        padding-bottom: 5rem;
      }
      .bg-gray-50 {
        background-color: #f9fafb;
      }
      .container {
        max-width: 80rem;
        margin-left: auto;
        margin-right: auto;
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .mx-auto {
        margin-left: auto;
        margin-right: auto;
      }
      .px-4 {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .mb-16 {
        margin-bottom: 4rem;
      }
      .text-xl {
        font-size: 1.25rem;
        line-height: 1.75rem;
      }
      .text-gray-600 {
        color: #4b5563;
      }
      .text-red-600 {
        color: #dc2626;
      }
      .text-lg {
        font-size: 1.125rem;
        line-height: 1.75rem;
      }
      .leading-relaxed {
        line-height: 1.625;
      }
      .leading-tight {
        line-height: 1.25;
      }

      /* 布局样式 */
      .grid {
        display: grid;
      }
      .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
      .gap-12 {
        gap: 3rem;
      }
      .items-center {
        align-items: center;
      }
      .space-y-8 > :not([hidden]) ~ :not([hidden]) {
        margin-top: 2rem;
      }

      @media (min-width: 1024px) {
        .lg\\:grid-cols-2 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .lg\\:text-left {
          text-align: left;
        }
      }

      /* 🚀 Speed Index极致优化 */
      @media (max-width: 768px) {
        /* 立即隐藏非关键内容 */
        .mobile-delayed-content {
          display: none !important;
        }

        .speed-loaded .mobile-delayed-content {
          display: block !important;
        }

        .mobile-header-delayed {
          display: none !important;
        }

        .mobile-header-minimal {
          display: block !important;
        }

        .speed-loaded .mobile-header-delayed {
          display: block !important;
        }

        .speed-loaded .mobile-header-minimal {
          display: none !important;
        }

        .mobile-footer-delayed {
          display: none !important;
        }

        .speed-loaded .mobile-footer-delayed {
          display: block !important;
        }

        /* 禁用所有动画提升Speed Index */
        *,
        *::before,
        *::after {
          animation: none !important;
          transition: none !important;
          transform: none !important;
          will-change: auto !important;
        }

        /* 关键图片立即显示 */
        .mobile-banner,
        .speed-critical {
          opacity: 1 !important;
          visibility: visible !important;
          display: block !important;
        }

        /* 非关键图片延迟加载 */
        img:not(.mobile-banner):not(.speed-critical) {
          loading: lazy;
          decoding: async;
          opacity: 0;
        }

        .speed-loaded img:not(.mobile-banner):not(.speed-critical) {
          opacity: 1;
        }
      }

      @media (min-width: 769px) {
        .mobile-delayed-content,
        .mobile-header-delayed,
        .mobile-footer-delayed {
          display: block;
        }

        .mobile-header-minimal {
          display: none;
        }
      }

      /* Banner优化 */
      .mobile-banner-container {
        width: 100%;
        height: 200px;
        margin: 0;
        padding: 0;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mobile-banner-instant-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        font-weight: bold;
      }

      .mobile-banner-instant-bg::after {
        content: "专业工程机械";
      }

      .mobile-banner-optimized {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 2;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .mobile-banner-optimized.loaded {
        opacity: 1;
      }

      /* 焦点样式 */
      .focus-visible-ring:focus-visible {
        outline: 2px solid #ef4444;
        outline-offset: 2px;
        border-radius: 0.25rem;
      }
    </style>

    <title>{title}</title>
  </head>
  <body>
    <!-- 🚀 移动端延迟Header -->
    <div class="mobile-header-delayed">
      <Header />
    </div>

    <!-- 移动端极简Header -->
    <div class="mobile-header-minimal">
      <header class="bg-white sticky top-0 z-50 shadow-sm">
        <div class="flex items-center justify-between h-16 px-4">
          <a href="/" class="flex items-center space-x-2">
            <span class="text-xl font-bold text-gray-800">永安重工</span>
          </a>
          <a
            href="/contact"
            class="bg-red-600 text-white px-4 py-2 rounded font-bold text-sm"
            >报价</a
          >
        </div>
      </header>
    </div>

    <!-- 主要内容 -->
    <main id="main-content">
      <slot />
    </main>

    <!-- 🚀 Partytown设备检测脚本 -->
    <script is:inline>
      console.log("🔍 设备检测...");

      const isMobile =
        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent,
        ) ||
        window.innerWidth <= 768 ||
        "ontouchstart" in window;

      console.log("🔍 设备类型:", isMobile ? "📱 移动端" : "🖥️ 桌面端");
      console.log("✅ 所有第三方脚本将通过Partytown在Web Worker中运行");
    </script>

    <!-- 🚀 Google Analytics - 通过Partytown运行 -->
    <script type="text/partytown">
      // Google Analytics 4
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-71JP66YM5X");

      // 加载GA脚本
      const gaScript = document.createElement("script");
      gaScript.async = true;
      gaScript.src = "https://www.googletagmanager.com/gtag/js?id=G-71JP66YM5X";
      document.head.appendChild(gaScript);

      console.log("📊 Google Analytics 已通过Partytown加载");
    </script>
    <script type="text/partytown">
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src =
          "https://cdn.huazhi.cloud/hzchat/dist/livechat.js?time=" +
          new Date().getTime();
        hm.setAttribute("_extID", "309-313-7n1iAECE");
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>

    <!-- 🚀 Speed Index激进优化 - 目标<2.5秒 -->
    <script>
      // 立即设置关键样式类
      document.documentElement.classList.add("speed-critical");

      // 移动端激进优化
      if (window.innerWidth <= 768) {
        // 立即隐藏所有非关键内容
        const style = document.createElement("style");
        style.textContent = `
          .mobile-delayed-content { display: none !important; }
          .mobile-header-delayed { display: none !important; }
          .mobile-footer-delayed { display: none !important; }
          img:not(.mobile-banner):not(.speed-critical) { opacity: 0 !important; }
        `;
        document.head.appendChild(style);

        // 立即显示关键Banner
        const banners = document.querySelectorAll(".mobile-banner");
        banners.forEach((banner) => {
          if (banner instanceof HTMLElement) {
            banner.style.opacity = "1";
            banner.style.visibility = "visible";
            banner.classList.add("speed-critical");
          }
        });

        // 极速延迟加载（减少到1.5秒）
        setTimeout(function () {
          document.body.classList.add("speed-loaded");
          console.log("⚡ Speed Index优化：1.5秒后加载非关键内容");
        }, 1500);
      } else {
        // 桌面端立即加载所有内容
        document.body.classList.add("speed-loaded");
      }

      // 性能监控
      if ("PerformanceObserver" in window) {
        try {
          const observer = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            const lcp = entries[entries.length - 1];
            console.log(`⚡ LCP: ${lcp.startTime.toFixed(2)}ms`);

            // 如果LCP > 2500ms，记录警告
            if (lcp.startTime > 2500) {
              console.warn("⚠️ LCP超过2.5秒，需要进一步优化");
            }
          });
          observer.observe({ entryTypes: ["largest-contentful-paint"] });
        } catch (e) {
          console.log("LCP monitoring not supported");
        }
      }
    </script>

    <!-- 🚀 移动端延迟Footer -->
    <div class="mobile-footer-delayed">
      <FooterSection />
    </div>
  </body>
</html>
