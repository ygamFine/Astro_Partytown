class d{constructor(e={}){this.baseUrl=e.baseUrl||"http://47.251.126.80/api",this.token=e.token||"2980bc69d09c767b2ca2e1c211a285c9f48985775a3f1d1313025838a611abbfe6d892a29b3417407ddd798d69a9f67f063c27d13827c1765f96b4bc19601295ac11fb9552f4a16ede2745813e3b536827069875ae8c5089a36da57cf69d08b252093e2100e0cc88ac700ca6cd6ebd196f0002bd5fb8219222ed778f8858ad21",this.defaultCacheTimeout=e.defaultCacheTimeout||3e4,this.enableNotifications=e.enableNotifications??!0,this.enableLogs=e.enableLogs??!0,this.retryTimes=e.retryTimes||3,this.retryDelay=e.retryDelay||1e3,this.cacheStrategies={menus:3e4,news:6e4,products:3e5,company:36e5,...e.cacheStrategies},this.activeCheckers=new Map,this.init()}init(){this.log("🚀 ISR缓存管理器初始化完成"),this.addVisibilityChangeListener()}async getData(e,t={}){const s={cacheTimeout:this.getCacheTimeout(e),transform:t.transform||this.getDefaultTransform(e),enableAutoUpdate:t.enableAutoUpdate??!0,...t},a=this.getCacheKey(e,t.params);try{const r=this.getCached(a);if(r&&!this.isExpired(r,s.cacheTimeout))return this.log(`📋 使用缓存数据: ${e}`),s.enableAutoUpdate&&this.startAutoUpdate(e,t,s),r.data;this.log(`🔄 从API获取数据: ${e}`);const i=await this.fetchFromAPI(e,t.params),c=s.transform?s.transform(i):i;return this.setCache(a,c,s.cacheTimeout),s.enableAutoUpdate&&this.startAutoUpdate(e,t,s),c}catch(r){this.log(`❌ 获取数据失败: ${e}`,r);const i=this.getCached(a);if(i)return this.log(`🛡️ 使用过期缓存作为降级: ${e}`),i.data;throw r}}async fetchFromAPI(e,t={}){const s=typeof window<"u";let a,r={};s?(a=new URL("/api/strapi-proxy",window.location.origin),a.searchParams.append("endpoint",e),Object.entries(t).forEach(([c,n])=>{a.searchParams.append(c,n)}),r={"Content-Type":"application/json"}):(a=new URL(`${this.baseUrl}/${e}`),Object.entries(t).forEach(([c,n])=>{a.searchParams.append(c,n)}),r={Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"});let i;for(let c=0;c<this.retryTimes;c++)try{this.log(`🔄 ${s?"代理":"直接"}请求 (${c+1}/${this.retryTimes}): ${e}`);const n=await fetch(a.toString(),{headers:r});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const l=await n.json();return this.log(`✅ 请求成功: ${e}`),l}catch(n){i=n,this.log(`⚠️ 第${c+1}次请求失败: ${e}`,n),c<this.retryTimes-1&&await this.delay(this.retryDelay*(c+1))}throw i}startAutoUpdate(e,t,s){const a=this.getCheckerId(e,t.params);if(this.activeCheckers.has(a))return;const r=setInterval(async()=>{try{await this.checkForUpdates(e,t,s)}catch(i){this.log(`⚠️ 自动更新检查失败: ${e}`,i)}},s.cacheTimeout);this.activeCheckers.set(a,r),this.log(`⏰ 启动自动更新检查: ${e} (${s.cacheTimeout}ms)`)}async checkForUpdates(e,t,s){const a=this.getCacheKey(e,t.params),r=this.getCached(a);if(r)try{const i=await this.fetchFromAPI(e,t.params),c=s.transform?s.transform(i):i;JSON.stringify(c)!==JSON.stringify(r.data)&&(this.log(`✨ 发现数据更新: ${e}`),this.setCache(a,c,s.cacheTimeout),this.triggerUpdateEvent(e,c,r.data),this.enableNotifications&&this.showUpdateNotification(e))}catch(i){this.log(`⚠️ 检查更新失败: ${e}`,i)}}triggerUpdateEvent(e,t,s){const a=new CustomEvent("isr-update",{detail:{endpoint:e,newData:t,oldData:s,timestamp:Date.now()}});document.dispatchEvent(a),this.log(`📡 触发更新事件: ${e}`)}showUpdateNotification(e){const t=document.querySelector(".isr-notification");t&&t.remove();const s=document.createElement("div");s.className="isr-notification",s.innerHTML=`
      <div class="isr-notification-content">
        <span class="isr-notification-icon">✨</span>
        <span>${this.getUpdateMessage(e)}</span>
      </div>
    `,Object.assign(s.style,{position:"fixed",top:"20px",right:"20px",zIndex:"10000",animation:"isrSlideIn 0.3s ease-out"});const a=s.querySelector(".isr-notification-content");Object.assign(a.style,{background:"#10b981",color:"white",padding:"12px 16px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",display:"flex",alignItems:"center",gap:"8px",fontSize:"14px",fontWeight:"500"}),document.body.appendChild(s),setTimeout(()=>{s.style.animation="isrFadeOut 0.3s ease-out forwards",setTimeout(()=>s.remove(),300)},3e3)}getUpdateMessage(e){return{menus:"菜单已更新",news:"新闻已更新",products:"产品已更新",company:"公司信息已更新"}[e]||`${e}已更新`}getCached(e){try{const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return this.log("缓存读取失败",t),null}}setCache(e,t,s){try{const a={data:t,timestamp:Date.now(),timeout:s};localStorage.setItem(e,JSON.stringify(a))}catch(a){this.log("缓存写入失败",a)}}isExpired(e,t){return Date.now()-e.timestamp>t}getCacheKey(e,t={}){const s=Object.keys(t).length>0?"_"+Object.entries(t).map(([a,r])=>`${a}=${r}`).join("&"):"";return`isr_cache_${e}${s}`}getCheckerId(e,t={}){return this.getCacheKey(e,t)+"_checker"}getCacheTimeout(e){return this.cacheStrategies[e]||this.defaultCacheTimeout}getDefaultTransform(e){return{menus:s=>s.data?.map(a=>({name:a.name,path:a.path,publishedAt:a.publishedAt}))||[],news:s=>s.data?.map(a=>({id:a.id,title:a.title,slug:a.slug,excerpt:a.excerpt,publishedAt:a.publishedAt,image:a.image}))||[],products:s=>s.data?.map(a=>({id:a.id,name:a.name,slug:a.slug,description:a.description,price:a.price,image:a.image}))||[]}[e]}addVisibilityChangeListener(){document.addEventListener("visibilitychange",()=>{document.hidden||(this.log("📱 页面重新可见，检查所有缓存更新..."),this.checkAllUpdates())})}async checkAllUpdates(){const e=[];this.activeCheckers.forEach((t,s)=>{const[a,r]=this.parseCheckerId(s);e.push(this.checkForUpdates(a,{params:r},{cacheTimeout:this.getCacheTimeout(a),transform:this.getDefaultTransform(a)}))}),await Promise.allSettled(e)}parseCheckerId(e){const[,t,s]=e.match(/isr_cache_([^_]+)(?:_(.+))?_checker/)||[],a=s?Object.fromEntries(s.split("&").map(r=>r.split("="))):{};return[t,a]}async forceRefresh(e,t={}){const s=this.getCacheKey(e,t);return localStorage.removeItem(s),this.log(`🔄 强制刷新缓存: ${e}`),this.getData(e,{params:t})}clearAllCache(){const e=Object.keys(localStorage).filter(t=>t.startsWith("isr_cache_"));e.forEach(t=>localStorage.removeItem(t)),this.log(`🗑️ 清除了 ${e.length} 个缓存项`)}stopAutoUpdate(e,t={}){const s=this.getCheckerId(e,t),a=this.activeCheckers.get(s);a&&(clearInterval(a),this.activeCheckers.delete(s),this.log(`⏹️ 停止自动更新: ${e}`))}stopAllAutoUpdates(){this.activeCheckers.forEach((e,t)=>{clearInterval(e)}),this.log(`⏹️ 停止了 ${this.activeCheckers.size} 个自动更新检查器`),this.activeCheckers.clear()}setCacheStrategy(e,t){this.cacheStrategies[e]=t,this.log(`⚙️ 设置缓存策略: ${e} = ${t}ms`)}getCacheStats(){const e=Object.keys(localStorage).filter(s=>s.startsWith("isr_cache_")),t={totalCaches:e.length,activeCheckers:this.activeCheckers.size,cacheItems:[]};return e.forEach(s=>{try{const a=JSON.parse(localStorage.getItem(s)),r=Date.now()-a.timestamp,i=r>a.timeout;t.cacheItems.push({key:s.replace("isr_cache_",""),age:Math.round(r/1e3)+"s",timeout:Math.round(a.timeout/1e3)+"s",isExpired:i,size:JSON.stringify(a.data).length})}catch{}}),t}delay(e){return new Promise(t=>setTimeout(t,e))}log(e,...t){this.enableLogs&&console.log(`[ISR] ${e}`,...t)}destroy(){this.stopAllAutoUpdates(),this.log("🔥 ISR缓存管理器已销毁")}}const h=new d;if(typeof document<"u"){const o=document.createElement("style");o.textContent=`
    @keyframes isrSlideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes isrFadeOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }
  `,document.head.appendChild(o)}typeof window<"u"&&window.location?.hostname==="localhost"&&(window.isrCache=h,console.log("🛠️ 开发模式 - ISR缓存管理器可通过 window.isrCache 访问"));class m{constructor(){this.init()}async init(){try{const e=await h.getData("menus");this.renderMenu(e),this.setupUpdateListener()}catch(e){console.error("菜单加载失败:",e),this.renderError()}}renderMenu(e){const t=document.getElementById("smart-menu"),s=document.getElementById("mobile-smart-menu");if(!(!t&&!s)){if(t){const a=e.map(r=>`
          <a href="${r.path}" 
             class="menu-item text-gray-600 hover:text-red-600 font-semibold focus-visible-ring transition-all duration-200">
            ${r.name}
          </a>
        `).join("");t.innerHTML=a}if(s){const a=e.map(r=>`
          <a href="${r.path}" 
             class="block text-gray-700 rounded-lg px-4 py-3 font-semibold focus-visible-ring touch-manipulation mobile-menu-item">
            ${r.name}
          </a>
        `).join("");s.innerHTML=a,this.setupMobileMenuClose(s)}t&&(t.classList.add("updated"),setTimeout(()=>{t.classList.remove("updated")},500))}}setupMobileMenuClose(e){e.querySelectorAll(".mobile-menu-item").forEach(t=>{t.addEventListener("click",()=>{const s=document.getElementById("mobile-menu"),a=document.getElementById("mobile-menu-button"),r=document.getElementById("menu-open-icon"),i=document.getElementById("menu-close-icon");s&&(s.classList.add("hidden"),a&&a.setAttribute("aria-expanded","false"),r&&r.classList.remove("hidden"),i&&i.classList.add("hidden"))})})}setupUpdateListener(){document.addEventListener("isr-update",e=>{e.detail.endpoint==="menus"&&(console.log("📡 收到菜单更新事件，重新渲染..."),this.renderMenu(e.detail.newData))})}renderError(){const e=document.getElementById("smart-menu");e&&(e.innerHTML=`
        <div class="error-message">
          <span class="text-red-500">⚠️ 菜单加载失败</span>
          <button onclick="window.smartMenuRenderer.init()" class="retry-btn">
            重试
          </button>
        </div>
      `)}}document.addEventListener("DOMContentLoaded",()=>{window.smartMenuRenderer=new m});
